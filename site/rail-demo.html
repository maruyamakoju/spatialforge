<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RailScan AI — AI軌道点検システム | SpatialForge</title>
  <meta name="description" content="営業列車に前方カメラを設置するだけ。毎運行ごとに線路全線を自動点検。専用検測車不要のAI軌道監視システム。">

  <!-- Stylesheet -->
  <link rel="stylesheet" href="rail-demo.css">

  <!-- CDN primary, local fallback for offline demos -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"
          onerror="this.onerror=null;this.src='js/three.min.js'"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"
          onerror="this.onerror=null;this.src='js/chart.min.js'"></script>
</head>
<body>

<!-- Nav -->
<nav>
  <a href="index.html" class="logo">
    Spatial<span style="color:var(--accent)">Forge</span>
    <span class="logo-badge">RAIL</span>
  </a>
  <div class="nav-links">
    <a href="#demo">デモ</a>
    <a href="#summary">サマリー</a>
    <a href="#kmmap">KM マップ</a>
    <a href="#dashboard">ダッシュボード</a>
    <a href="#specs">技術仕様</a>
    <a href="#roi">ROI比較</a>
    <a href="proposal.html">提案書</a>
    <a href="railscan-platform.html" style="color:var(--indigo)">プラットフォーム</a>
    <a href="whitepaper.html" style="color:var(--safe)">白書</a>
    <a href="#cta" class="nav-cta">資料請求</a>
  </div>
</nav>

<!-- Hero -->
<div class="hero">
  <div class="hero-badge">
    <span>AI軌道点検システム</span>
    &nbsp;|&nbsp; Railway Track Inspection AI
  </div>
  <h1>
    専用検測車は<br>
    <span class="highlight">もう不要です。</span>
  </h1>
  <p class="sub">
    営業列車の前方カメラ1台で、毎運行ごとに全線を自動点検。
    AIがレールき裂・締結装置欠損・まくらぎ損傷など11種類の軌道欠陥をリアルタイム検知・分類します。
  </p>
  <div class="hero-stats">
    <div class="stat">
      <span class="stat-num" id="stat1">0</span>
      <span class="stat-label">km 分析実績</span>
    </div>
    <div class="stat">
      <span class="stat-num" id="stat2">0</span>
      <span class="stat-label">ms 推論速度（RTX）</span>
    </div>
    <div class="stat">
      <span class="stat-num" id="stat3">0</span>
      <span class="stat-label">x 点検頻度向上</span>
    </div>
    <div class="stat">
      <span class="stat-num" id="stat4">0</span>
      <span class="stat-label">% 深夜作業削減</span>
    </div>
  </div>
  <div class="hero-btns">
    <a href="#demo" class="btn-primary">▶ 実映像デモを見る</a>
    <a href="#cta" class="btn-secondary">資料請求</a>
  </div>
</div>

<!-- Demo Section -->
<div id="demo" style="background: var(--surface); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);">
<section class="demo-section">
  <div class="section-label">Live Demo — Real Inference</div>
  <h2 class="section-title">
    AI深度解析デモ
    <span style="font-size:0.6rem;background:var(--safe);color:#000;padding:3px 9px;border-radius:4px;vertical-align:middle;font-weight:800;letter-spacing:0.06em;margin-left:0.75rem">実映像 / REAL DATA</span>
  </h2>
  <p class="section-sub">
    実際のJR路線映像（2路線 / 12キーフレーム）を YOLOv8m v2 欠陥検知モデル（5,052枚学習 / RTX 4090 / 平均13ms/フレーム）でリアルタイム処理した結果です。
    フレームを選択すると深度マップと共に<strong style="color:var(--accent)">欠陥バウンディングボックスがアニメーション表示</strong>されます。自動再生でフレームをシーケンシャルに確認できます。
  </p>

  <!-- Real data proof bar -->
  <div class="real-data-bar">
    <span class="rdb-label">✓ 実AI推論</span>
    <span class="rdb-chip">深度: Depth Anything V2 Large-hf</span>
    <span class="rdb-chip">欠陥検知: YOLOv8m v2 (4クラス)</span>
    <span class="rdb-chip">デバイス: RTX 4090 (CUDA)</span>
    <span class="rdb-chip">処理: ~13 ms/フレーム</span>
    <span class="rdb-chip">学習: 5,052枚 / mAP@50=44.7%</span>
    <span class="rdb-chip">検出: 39件 / 12フレーム（緊急13件・重要20件・軽微6件）</span>
  </div>

  <!-- Video tabs -->
  <div class="video-tabs">
    <button class="video-tab active" data-vid="jrsam3" onclick="selectVideo('jrsam3')">
      <span class="tab-dot dot-green"></span> jrsam3 路線
    </button>
    <button class="video-tab" data-vid="jr23" onclick="selectVideo('jr23')">
      <span class="tab-dot dot-blue"></span> jr23 路線
    </button>
    <button class="video-tab" data-vid="upload" onclick="selectVideo('upload')">
      <span class="tab-dot dot-upload"></span> 画像アップロード
    </button>
    <button class="video-tab" data-vid="player" onclick="selectVideo('player')" style="border-color:rgba(99,102,241,0.4)">
      <span class="tab-dot" style="background:var(--indigo)"></span> ▶ 動画プレーヤー
      <span style="font-size:0.6rem;background:var(--indigo);color:#fff;padding:1px 5px;border-radius:3px;margin-left:2px;font-weight:800">NEW</span>
    </button>
    <button class="video-tab" data-vid="webcam" onclick="selectVideo('webcam')" style="border-color:rgba(34,197,94,0.4)">
      <span class="tab-dot" style="background:var(--safe)"></span> 📷 ライブカメラ
      <span style="font-size:0.6rem;background:var(--safe);color:#000;padding:1px 5px;border-radius:3px;margin-left:2px;font-weight:800">LIVE</span>
    </button>
  </div>

  <!-- Keyboard hint + auto-play -->
  <div style="margin-bottom:0.75rem;display:flex;align-items:center;gap:1rem;flex-wrap:wrap">
    <span class="kbd-hint">
      <kbd class="kbd">1</kbd>–<kbd class="kbd">5</kbd> タブ切替 &nbsp;
      <kbd class="kbd">←</kbd><kbd class="kbd">→</kbd> フレーム &nbsp;
      <kbd class="kbd">Space</kbd> 再生/停止 &nbsp;
      <kbd class="kbd">N</kbd>/<kbd class="kbd">P</kbd> 次/前の異常
    </span>
    <button id="autoPlayBtn" onclick="toggleKeyframeAutoPlay()" style="background:rgba(34,197,94,0.12);border:1px solid rgba(34,197,94,0.3);color:var(--safe);font-size:0.75rem;font-weight:700;padding:4px 12px;border-radius:5px;cursor:pointer;white-space:nowrap">▶ 自動再生</button>
  </div>

  <!-- Frame selector strip -->
  <div class="frame-strip-outer" id="frameStrip">
    <div class="frame-strip-inner" id="frameStripInner">
      <!-- populated by JS -->
    </div>
  </div>

  <!-- ── Video Player (hidden by default) ─────────────────── -->
  <div id="videoPlayerSection" style="display:none">
    <div class="player-sub-tabs" style="justify-content:space-between;flex-wrap:wrap;gap:0.5rem">
      <div style="display:flex;gap:0.5rem">
        <button class="pvtab active" onclick="loadTimeline('jrsam3',this)">jrsam3 路線</button>
        <button class="pvtab" onclick="loadTimeline('jr23',this)">jr23 路線</button>
      </div>
      <a id="mp4DownloadBtn" href="" download class="mp4-dl-btn">
        📥 MP4 ダウンロード
      </a>
    </div>

    <!-- Loading placeholder -->
    <div class="player-loading" id="playerLoading">
      <div class="player-spinner"></div>
      <span>タイムラインを読み込み中...</span>
    </div>

    <!-- Player (shown after timeline loads) -->
    <div id="playerReady" style="display:none">

      <!-- Mode toggle -->
      <div class="player-mode-toggle">
        <button class="pmode-btn active" id="pmBtn-video" onclick="setPlayerMode('video')">▶ 動画再生</button>
        <button class="pmode-btn" id="pmBtn-frame" onclick="setPlayerMode('frame')">🔬 フレーム解析</button>
      </div>

      <!-- ── VIDEO MODE ─────────────────────────────── -->
      <div id="pm-video-wrap">
        <video id="playerVideo" controls loop playsinline preload="metadata">
          お使いのブラウザは動画再生に対応していません。
        </video>
        <div class="events-panel" id="eventsPanel">
          <!-- populated by buildEventsPanel() -->
        </div>
        <div style="display:flex;justify-content:flex-end;margin-top:0.6rem">
          <button onclick="printReport()" class="btn-secondary" style="font-size:0.82rem;padding:0.45rem 1.1rem;gap:0.4rem">
            📋 点検レポート出力
          </button>
        </div>
      </div>

      <!-- ── FRAME MODE ─────────────────────────────── -->
      <div id="pm-frame-wrap" style="display:none">
        <div class="player-wrap">
          <img id="playerImg" src="" alt="frame">
          <div class="player-hud">
            <span class="player-ts-badge" id="playerTs">0.0s</span>
            <span class="player-anom-hud" id="playerAnomHud"></span>
          </div>
          <span class="player-model-chip">DA V2 Large</span>
          <div class="player-anom-flash" id="playerAnomFlash"></div>
        </div>

        <div class="player-controls">
          <button class="play-btn" id="playBtn" onclick="togglePlay()">▶</button>
          <input type="range" id="playerScrubber" min="0" max="1" value="0" step="1"
                 oninput="scrubTo(parseInt(this.value))">
          <span class="player-time-display" id="playerTimeDisplay">0.0s / 0.0s</span>
          <button class="speed-btn" id="speedBtn" onclick="cycleSpeed()">1×</button>
        </div>

        <div class="spark-wrap">
          <div class="spark-title">⚠ 異常スコアタイムライン — クリックでジャンプ</div>
          <canvas id="sparkCanvas" height="64"></canvas>
        </div>

        <div class="info-grid" style="margin-top:1rem">
          <div class="alert-panel">
            <h3>⚠ フレーム検知アラート</h3>
            <div id="playerAlertList">
              <div style="color:var(--muted);font-size:0.85rem;padding:0.5rem 0">フレームを選択中...</div>
            </div>
          </div>
          <div class="metric-panel">
            <h3>📐 フレーム計測データ</h3>
            <div class="metric-row"><span class="metric-key">タイムスタンプ</span><span class="metric-val" id="pm-ts">—</span></div>
            <div class="metric-row"><span class="metric-key">前方距離（最短）</span><span class="metric-val" id="pm-near">—</span></div>
            <div class="metric-row"><span class="metric-key">前方距離（最遠）</span><span class="metric-val" id="pm-far">—</span></div>
            <div class="metric-row"><span class="metric-key">異常スコア</span><span class="metric-val" id="pm-score">—</span></div>
            <div class="metric-row"><span class="metric-key">信頼度</span><span class="metric-val" id="pm-conf">—</span></div>
            <div class="metric-row"><span class="metric-key">処理時間</span><span class="metric-val" id="pm-ms">—</span></div>
          </div>
        </div>
      </div><!-- /pm-frame-wrap -->

    </div><!-- /playerReady -->
  </div><!-- /videoPlayerSection -->

  <!-- ── Webcam Live Section (hidden by default) ──────────── -->
  <div id="webcamSection">
    <div class="webcam-controls">
      <button id="webcamBtn" class="btn-webcam-start" onclick="toggleWebcam()">📷 カメラ起動</button>
      <div class="webcam-status" id="webcamStatus">
        カメラを起動してリアルタイム深度解析を開始します。<br>
        <span style="font-size:0.75rem;opacity:0.7">※ demo_server.py が起動している必要があります（localhost:8765）</span>
      </div>
    </div>

    <div class="webcam-layout">
      <div class="webcam-panel">
        <video id="webcamVideo" autoplay muted playsinline></video>
        <div class="webcam-label live" id="webcamLiveLabel" style="display:none">LIVE CAMERA</div>
      </div>
      <div class="webcam-panel">
        <img id="webcamOverlay" src="rail-assets/jrsam3_11s_overlay.jpg" alt="Depth overlay">
        <div class="webcam-label">AI 深度解析 出力</div>
        <div class="webcam-fps-badge" id="webcamFpsBadge">—</div>
      </div>
    </div>

    <div class="webcam-info-grid">
      <div class="wc-metric"><div class="wc-val" id="wc-near">—</div><div class="wc-lbl">最近距離</div></div>
      <div class="wc-metric"><div class="wc-val" id="wc-far">—</div><div class="wc-lbl">最遠距離</div></div>
      <div class="wc-metric"><div class="wc-val" id="wc-ms">—</div><div class="wc-lbl">処理時間</div></div>
      <div class="wc-metric"><div class="wc-val" id="wc-anom">—</div><div class="wc-lbl">異常検知</div></div>
    </div>
  </div>

  <!-- Upload Zone (hidden by default) -->
  <div id="uploadZone" style="display:none">
    <div id="apiStatusBar" style="display:flex;align-items:center;gap:8px;margin-bottom:10px;font-size:0.78rem;color:var(--muted)">
      <span id="apiDot" style="width:8px;height:8px;border-radius:50%;background:#555;display:inline-block;flex-shrink:0"></span>
      <span id="apiStatusText">APIステータス確認中…</span>
    </div>
    <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
      <div class="upload-icon">📁</div>
      <p><strong>クリックまたはドラッグ</strong>して画像をアップロード</p>
      <p style="margin-top:0.25rem;font-size:0.8rem">JPEG / PNG / WebP 対応 (最大20MB)</p>
    </div>
    <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleUpload(this.files[0])">
  </div>

  <!-- Main image panels -->
  <div class="demo-grid" id="mainDisplay">
    <div class="img-panel-wrap" style="position:relative">
      <span class="panel-label live">● カメラ映像 / Camera</span>
      <img id="cameraImg" src="rail-assets/jrsam3_11s_camera.jpg" alt="Camera feed">
      <canvas id="bboxCanvas" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:auto"></canvas>
      <div class="proc-flash" id="procFlash"></div>
      <div class="frame-info-badge" id="frameLabel">jrsam3 — 11s</div>
      <button id="bboxToggleBtn" onclick="toggleBboxOverlay()" title="バウンディングボックス表示切替" style="position:absolute;bottom:8px;right:8px;z-index:15;background:rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.2);color:#fff;font-size:0.72rem;padding:3px 8px;border-radius:5px;cursor:pointer">BBox ON</button>
    </div>
    <div class="img-panel-wrap">
      <span class="panel-label">深度 + 欠陥検知 / Depth+Defect</span>
      <span class="model-chip">DA V2 Large + YOLOv8</span>
      <img id="overlayImg" src="rail-assets/jrsam3_11s_overlay.jpg" alt="Depth overlay">
      <div class="depth-legend">
        <div class="depth-legend-title">DISTANCE</div>
        <div class="depth-scale"></div>
        <div class="depth-scale-labels"><span>遠 / Far</span><span>近 / Near</span></div>
      </div>
    </div>
  </div>

  <!-- Alert + Metric panels -->
  <div class="info-grid" id="infoPanels">
    <div class="alert-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
        <h3 style="margin:0">⚠ 欠陥検知アラート / Defect Detection</h3>
        <button onclick="printKeyframeReport()" title="このフレームの点検レポートを出力" style="background:rgba(245,158,11,0.12);border:1px solid rgba(245,158,11,0.3);color:var(--accent);font-size:0.72rem;padding:3px 9px;border-radius:5px;cursor:pointer;font-weight:700;white-space:nowrap">📋 レポート</button>
      </div>
      <div id="alertList">
        <div style="color:var(--muted);font-size:0.85rem;padding:1rem 0;text-align:center">読み込み中...</div>
      </div>
    </div>
    <div class="metric-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
        <h3 style="margin:0">📐 計測データ / Measurements</h3>
        <button onclick="shareCurrentFrame()" title="このフレームのURLをコピー" style="background:transparent;border:1px solid var(--border);color:var(--muted);font-size:0.72rem;padding:3px 8px;border-radius:5px;cursor:pointer" id="shareBtn">🔗 シェア</button>
      </div>
      <div class="metric-row"><span class="metric-key">前方距離（最短）</span><span class="metric-val" id="m-near">—</span></div>
      <div class="metric-row"><span class="metric-key">前方距離（最遠）</span><span class="metric-val" id="m-far">—</span></div>
      <div class="metric-row"><span class="metric-key">建築限界余裕</span><span class="metric-val" id="m-clearance">—</span></div>
      <div class="metric-row"><span class="metric-key">信頼度スコア</span><span class="metric-val" id="m-conf">—</span></div>
      <div class="metric-row"><span class="metric-key">検知異常数</span><span class="metric-val" id="m-anom">—</span></div>
      <div class="metric-row"><span class="metric-key">処理時間</span><span class="metric-val" id="m-time">—</span></div>
      <div class="metric-row"><span class="metric-key">使用モデル</span><span class="metric-val" id="m-model">—</span></div>
    </div>
  </div>
</section>
</div>

<!-- Detection Summary Dashboard -->
<div style="background: var(--bg); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);">
<section id="summary">
  <div class="section-label">Detection Summary</div>
  <h2 class="section-title">検出サマリーダッシュボード</h2>
  <p class="section-sub">12キーフレームの全検出結果を重要度別・欠陥種別に集計。YOLOv8m v2モデルによる実推論データ。</p>

  <div class="summary-grid">
    <!-- Severity breakdown -->
    <div class="summary-card">
      <h3 class="summary-card-title">重要度別分布</h3>
      <div class="summary-bars">
        <div class="summary-bar-row">
          <span class="summary-bar-label" style="color:#ef4444">緊急</span>
          <div class="summary-bar-track">
            <div class="summary-bar-fill" style="width:33.3%;background:rgba(239,68,68,0.6);border:1px solid rgba(239,68,68,0.8)">13件</div>
          </div>
          <span class="summary-bar-pct" style="color:#ef4444">33%</span>
        </div>
        <div class="summary-bar-row">
          <span class="summary-bar-label" style="color:#f59e0b">重要</span>
          <div class="summary-bar-track">
            <div class="summary-bar-fill" style="width:51.3%;background:rgba(245,158,11,0.5);border:1px solid rgba(245,158,11,0.7)">20件</div>
          </div>
          <span class="summary-bar-pct" style="color:#f59e0b">51%</span>
        </div>
        <div class="summary-bar-row">
          <span class="summary-bar-label" style="color:#3b82f6">軽微</span>
          <div class="summary-bar-track">
            <div class="summary-bar-fill" style="width:15.4%;background:rgba(59,130,246,0.5);border:1px solid rgba(59,130,246,0.7)">6件</div>
          </div>
          <span class="summary-bar-pct" style="color:#3b82f6">15%</span>
        </div>
      </div>
      <div class="summary-total">合計 <strong style="color:var(--accent)">39件</strong> / 12フレーム</div>
    </div>

    <!-- Per-class breakdown -->
    <div class="summary-card">
      <h3 class="summary-card-title">欠陥種別分布</h3>
      <div class="summary-bars">
        <div class="summary-bar-row">
          <span class="summary-bar-label">レール剥離</span>
          <div class="summary-bar-track">
            <div class="summary-bar-fill" style="width:51.3%;background:rgba(245,158,11,0.5);border:1px solid rgba(245,158,11,0.7)">20件</div>
          </div>
          <span class="summary-bar-pct" style="color:#f59e0b">51%</span>
        </div>
        <div class="summary-bar-row">
          <span class="summary-bar-label">レールき裂</span>
          <div class="summary-bar-track">
            <div class="summary-bar-fill" style="width:33.3%;background:rgba(239,68,68,0.6);border:1px solid rgba(239,68,68,0.8)">13件</div>
          </div>
          <span class="summary-bar-pct" style="color:#ef4444">33%</span>
        </div>
        <div class="summary-bar-row">
          <span class="summary-bar-label">波状摩耗</span>
          <div class="summary-bar-track">
            <div class="summary-bar-fill" style="width:15.4%;background:rgba(59,130,246,0.5);border:1px solid rgba(59,130,246,0.7)">6件</div>
          </div>
          <span class="summary-bar-pct" style="color:#3b82f6">15%</span>
        </div>
      </div>
      <div class="summary-total">最高信頼度 <strong style="color:var(--accent)">92%</strong> / 平均 <strong>54%</strong></div>
    </div>

    <!-- Model performance -->
    <div class="summary-card summary-card-highlight">
      <h3 class="summary-card-title">モデル性能</h3>
      <div class="summary-metrics">
        <div class="summary-metric">
          <div class="summary-metric-val" style="color:var(--accent)">44.7%</div>
          <div class="summary-metric-label">mAP@50</div>
        </div>
        <div class="summary-metric">
          <div class="summary-metric-val" style="color:var(--safe)">62.5%</div>
          <div class="summary-metric-label">適合率</div>
        </div>
        <div class="summary-metric">
          <div class="summary-metric-val" style="color:var(--indigo)">11ms</div>
          <div class="summary-metric-label">平均推論</div>
        </div>
        <div class="summary-metric">
          <div class="summary-metric-val" style="color:var(--text)">5,052</div>
          <div class="summary-metric-label">学習画像数</div>
        </div>
      </div>
      <div class="summary-model-info">
        <span>YOLOv8m v2</span> · <span>4クラス</span> · <span>92エポック（Early Stop@62）</span>
      </div>
    </div>
  </div>

  <!-- Action buttons -->
  <div style="display:flex;gap:0.75rem;justify-content:center;flex-wrap:wrap;margin-top:1.5rem">
    <button onclick="printAllFramesReport()" style="background:var(--accent);color:#000;border:none;padding:0.6rem 1.4rem;border-radius:8px;font-weight:700;font-size:0.88rem;cursor:pointer">
      📋 全フレーム一括レポート出力
    </button>
    <button onclick="exportDetectionJson()" style="background:transparent;color:var(--indigo);border:1px solid var(--indigo);padding:0.6rem 1.4rem;border-radius:8px;font-weight:700;font-size:0.88rem;cursor:pointer">
      ⬇ 検出データ JSON エクスポート
    </button>
  </div>
</section>
</div>

<!-- 3D Visualization -->
<div class="full-section" id="viz" style="background: var(--bg); border-bottom: 1px solid var(--border);">
<div class="viz-inner">
  <div class="section-label">3D Visualization</div>
  <h2 class="section-title">インタラクティブ3D深度マップ</h2>
  <p class="section-sub">選択したフレームの深度データを3次元空間に変換。軌道前方の立体構造をあらゆる角度から確認できます。</p>
  <canvas id="threeCanvas"></canvas>
  <div class="viz-controls">
    <button class="viz-btn active" onclick="setVizMode('point',event)">ポイントクラウド</button>
    <button class="viz-btn" onclick="setVizMode('mesh',event)">3Dメッシュ</button>
    <button class="viz-btn" onclick="resetCamera()">カメラリセット</button>
    <button class="viz-btn" onclick="toggleAutoRotate(event)">自動回転</button>
  </div>
  <div class="viz-hint">マウスドラッグで回転 · スクロールでズーム</div>
</div>
</div>

<!-- Route Kilometer Map -->
<div id="kmmap" style="background: var(--surface); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);">
<section>
  <div class="section-label">Route Kilometer Map</div>
  <h2 class="section-title">路線キロ程異常マップ</h2>
  <p class="section-sub">
    各異常検知イベントを走行距離（キロ程）に変換して可視化します。
    保線担当者が「何キロ地点に何があるか」を直感的に把握できます。マーカーをクリックするとフレームにジャンプします。
  </p>

  <div class="km-map-wrap">
    <div class="km-map-header">
      <h3>🛤 異常位置マップ（キロ程ベース）</h3>
      <div class="km-route-toggle">
        <button class="km-route-btn active" data-route="jrsam3" onclick="renderKmMap('jrsam3')">jrsam3 路線</button>
        <button class="km-route-btn" data-route="jr23" onclick="renderKmMap('jr23')">jr23 路線</button>
      </div>
    </div>

    <div class="km-map-svg-wrap">
      <div id="kmMapSvgWrap">
        <!-- populated by renderKmMap() -->
      </div>
    </div>

    <div class="km-legend">
      <div class="km-legend-item">
        <div class="km-legend-dot" style="background:#ef4444;border:1.5px solid #ef4444"></div>
        <span>緊急（critical）— レールき裂・継目異状等</span>
      </div>
      <div class="km-legend-item">
        <div class="km-legend-dot" style="background:#f59e0b;border:1.5px solid #f59e0b"></div>
        <span>重要（major）— 摩耗・締結装置・まくらぎ等</span>
      </div>
      <div class="km-legend-item">
        <div class="km-legend-dot" style="background:#3b82f6;border:1.5px solid #3b82f6"></div>
        <span>軽微（minor）— バラスト異状・波状摩耗等</span>
      </div>
      <div class="km-legend-item">
        <div class="km-legend-dot" style="background:#22c55e;border:1.5px solid #22c55e"></div>
        <span>正常フレーム</span>
      </div>
    </div>

    <div class="km-speed-note">
      ⚡ キロ程換算: 80 km/h（22.2 m/s）で走行した場合の推定距離。実運用では GPS キロ程データと統合します。
    </div>
  </div>
</section>
</div>

<!-- Dashboard -->
<div style="background: var(--bg); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);">
<section id="dashboard">
  <div class="section-label">Monitoring Dashboard</div>
  <h2 class="section-title">路線監視ダッシュボード</h2>
  <p class="section-sub">導入後のリアルタイム監視画面のイメージです。全列車・全区間の点検データを一元管理します。</p>

  <div class="dash-grid">
    <div class="kpi-card kpi-safe">
      <div class="kpi-label">本日の点検カバレッジ</div>
      <div class="kpi-value" style="color:var(--safe)">847<span style="font-size:1.1rem">km</span></div>
      <div class="kpi-sub">総路線距離の 100%</div>
    </div>
    <div class="kpi-card kpi-danger">
      <div class="kpi-label">要確認アラート</div>
      <div class="kpi-value" style="color:var(--danger)" id="dash-alerts">39</div>
      <div class="kpi-sub" style="color:var(--danger)">▲ 緊急13件 / 重要20件 / 軽微6件</div>
    </div>
    <div class="kpi-card kpi-accent">
      <div class="kpi-label">本日の点検回数</div>
      <div class="kpi-value" style="color:var(--accent)" id="dash-runs">214</div>
      <div class="kpi-sub">運行便数ベース（自動）</div>
    </div>
    <div class="kpi-card kpi-indigo">
      <div class="kpi-label">処理済フレーム数（実績）</div>
      <div class="kpi-value" style="color:var(--indigo)">5,052<span style="font-size:1.1rem">枚</span></div>
      <div class="kpi-sub">avg 13 ms / frame · YOLOv8m v2</div>
    </div>
  </div>

  <div class="charts-grid">
    <div class="chart-card">
      <h4>異常検知トレンド（過去30日）</h4>
      <div class="chart-container">
        <canvas id="trendChart"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <h4>異常種別分布</h4>
      <div class="chart-container">
        <canvas id="typeChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Per-frame real data bar chart -->
  <div class="chart-card" style="margin-top:1rem">
    <h4>実測データ — フレーム別検知数 / 重要度別（12キーフレーム・YOLOv8m v2 実推論）</h4>
    <div class="chart-container" style="height:180px">
      <canvas id="frameChart"></canvas>
    </div>
  </div>

  <div class="alert-log">
    <h4>本日の検知ログ — YOLOv8m v2 欠陥検知結果（39件）</h4>
    <div class="log-item">
      <span class="log-time">06:12:04</span>
      <span class="log-badge badge-warning" style="background:#f59e0b">重要</span>
      <div>
        <div class="log-text"><strong>レール剥離</strong>検知 — 前方 7.3 m（信頼度 92%・面積 15,347 px²）</div>
        <div class="log-loc">jrsam3路線 / t=2s / YOLOv8m v2 · 10ms</div>
      </div>
    </div>
    <div class="log-item">
      <span class="log-time">06:12:04</span>
      <span class="log-badge badge-critical">緊急</span>
      <div>
        <div class="log-text"><strong>レールき裂</strong>検知 — 前方 <strong>8.9 m</strong>（信頼度 56%・面積 66,992 px²）</div>
        <div class="log-loc">jrsam3路線 / t=2s / YOLOv8m v2 · 10ms</div>
      </div>
    </div>
    <div class="log-item">
      <span class="log-time">06:14:08</span>
      <span class="log-badge badge-warning" style="background:#f59e0b">重要</span>
      <div>
        <div class="log-text"><strong>レール剥離</strong>検知 — 前方 10.6 m（信頼度 85%・面積 16,830 px²）</div>
        <div class="log-loc">jrsam3路線 / t=4s / YOLOv8m v2 · 8ms</div>
      </div>
    </div>
    <div class="log-item">
      <span class="log-time">06:17:14</span>
      <span class="log-badge badge-warning" style="background:#f59e0b">重要</span>
      <div>
        <div class="log-text"><strong>レール剥離</strong>検知 — 前方 6.2 m（信頼度 84%・面積 148,680 px²）</div>
        <div class="log-loc">jrsam3路線 / t=7s / YOLOv8m v2 · 13ms</div>
      </div>
    </div>
    <div class="log-item">
      <span class="log-time">06:21:22</span>
      <span class="log-badge badge-warning" style="background:#f59e0b">重要</span>
      <div>
        <div class="log-text"><strong>レール剥離</strong>検知 — 前方 9.1 m（信頼度 83%・面積 14,382 px²）</div>
        <div class="log-loc">jrsam3路線 / t=11s / YOLOv8m v2 · 15ms</div>
      </div>
    </div>
    <div class="log-item">
      <span class="log-time">06:21:22</span>
      <span class="log-badge badge-critical">緊急</span>
      <div>
        <div class="log-text"><strong>レールき裂</strong>検知 — 前方 <strong>7.3 m</strong>（信頼度 54%・面積 84,322 px²）</div>
        <div class="log-loc">jrsam3路線 / t=11s / YOLOv8m v2 · 15ms</div>
      </div>
    </div>
    <div class="log-item">
      <span class="log-time">06:26:32</span>
      <span class="log-badge badge-critical">緊急</span>
      <div>
        <div class="log-text"><strong>レールき裂</strong>検知 — 前方 <strong>10.8 m</strong>（信頼度 81%・面積 79,112 px²）</div>
        <div class="log-loc">jrsam3路線 / t=21s / YOLOv8m v2 · 10ms</div>
      </div>
    </div>
    <div class="log-item">
      <span class="log-time">11:08:44</span>
      <span class="log-badge badge-critical">緊急</span>
      <div>
        <div class="log-text"><strong>レールき裂</strong>検知 — 前方 <strong>8.2 m</strong>（信頼度 79%・面積 76,440 px²）</div>
        <div class="log-loc">jr23路線 / t=2s / YOLOv8m v2 · 10ms</div>
      </div>
    </div>
    <div class="log-item">
      <span class="log-time">11:10:48</span>
      <span class="log-badge badge-warning" style="background:#f59e0b">重要</span>
      <div>
        <div class="log-text"><strong>レール剥離</strong>検知 — 前方 10.2 m（信頼度 79%・面積 4,473 px²）</div>
        <div class="log-loc">jr23路線 / t=4s / YOLOv8m v2 · 11ms</div>
      </div>
    </div>
    <div class="log-item">
      <span class="log-time">16:38:12</span>
      <span class="log-badge badge-ok">完了</span>
      <div>
        <div class="log-text">本日のスキャン完了 — 2路線 12キーフレーム処理 / <strong>39件の欠陥を検知</strong></div>
        <div class="log-loc">緊急13件・重要20件・軽微6件 / 平均処理時間 11ms · YOLOv8m v2 · RTX 4090</div>
      </div>
    </div>
  </div>
</section>
</div>

<!-- Specs -->
<section id="specs">
  <div class="section-label">Technology</div>
  <h2 class="section-title">技術仕様</h2>
  <p class="section-sub">YOLOv8m v2（5,052枚学習 / mAP@50=44.7%）+ Depth Anything V2 を基盤とした鉄道専用軌道点検エンジン。4クラス欠陥検出・重要度自動判定。</p>
  <div class="specs-grid">
    <div class="spec-card">
      <div class="spec-icon">📷</div>
      <h3>ハードウェア要件</h3>
      <p>既存の営業車両に搭載するだけ。特殊センサー不要。</p>
      <ul class="spec-list">
        <li>前方カメラ（720p以上）</li>
        <li>LiDAR・レーザー不要</li>
        <li>ステレオカメラ不要（単眼でOK）</li>
        <li>Wi-Fi／LTE経由でクラウド送信</li>
        <li>エッジ処理オプション対応</li>
      </ul>
    </div>
    <div class="spec-card">
      <div class="spec-icon">🧠</div>
      <h3>AI検知能力（11クラス分類）</h3>
      <p>Depth Anything V2 + YOLOv8 による2段階マルチレイヤー解析。</p>
      <ul class="spec-list">
        <li>レールき裂・摩耗・波状摩耗・剥離</li>
        <li>締結装置の欠損・破損</li>
        <li>まくらぎき裂・腐食</li>
        <li>バラスト異状・継目異状・軌間異常</li>
        <li>4段階重要度自動判定（緊急/重要/軽微/参考）</li>
      </ul>
    </div>
    <div class="spec-card">
      <div class="spec-icon">📊</div>
      <h3>出力データ（実装済）</h3>
      <p>保線担当者がすぐに使える形式で自動レポート生成。</p>
      <ul class="spec-list">
        <li>欠陥分類レポート（HTML/PDF・日本語）</li>
        <li>深度カラーマップ + 欠陥バウンディングボックス</li>
        <li>重要度別サマリー・KM ポスト位置情報</li>
        <li>3D点群データ（.ply / .pcd）</li>
        <li>REST API / JSON / 点検レポート一括出力</li>
      </ul>
    </div>
  </div>
</section>

<!-- ROI / Cost Comparison -->
<div style="background: var(--surface); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);">
<section id="roi">
  <div class="section-label">Cost &amp; ROI</div>
  <h2 class="section-title">検測車との比較</h2>
  <p class="section-sub">営業列車 + 前方カメラだけで、専用検測車を超える点検頻度をコストの数分の一で実現します。</p>

  <div style="overflow-x:auto;margin-bottom:2rem">
    <table style="width:100%;border-collapse:collapse;font-size:0.9rem">
      <thead>
        <tr style="border-bottom:2px solid var(--border)">
          <th style="text-align:left;padding:0.75rem 1rem;color:var(--muted);font-weight:600;font-size:0.78rem;letter-spacing:0.06em;text-transform:uppercase">比較項目</th>
          <th style="text-align:center;padding:0.75rem 1rem;color:var(--muted);font-weight:600;font-size:0.78rem;letter-spacing:0.06em;text-transform:uppercase">従来（専用検測車）</th>
          <th style="text-align:center;padding:0.75rem 1rem;color:var(--accent);font-weight:700;font-size:0.78rem;letter-spacing:0.06em;text-transform:uppercase">RailScan AI</th>
        </tr>
      </thead>
      <tbody>
        <tr style="border-bottom:1px solid var(--border)">
          <td style="padding:0.75rem 1rem;font-weight:600">初期費用</td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--danger)">3〜10億円<br><span style="font-size:0.75rem;color:var(--muted)">検測車両導入・改造費</span></td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--safe);font-weight:700">カメラ取付のみ<br><span style="font-size:0.75rem;color:var(--muted)">既存車両に後付け可</span></td>
        </tr>
        <tr style="border-bottom:1px solid var(--border);background:rgba(255,255,255,0.02)">
          <td style="padding:0.75rem 1rem;font-weight:600">点検頻度</td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--danger)">月1〜4回<br><span style="font-size:0.75rem;color:var(--muted)">深夜の専用ダイヤ必要</span></td>
          <td style="padding:0.75rem 1rem;text-align:center;font-weight:700"><strong style="font-size:1.1rem;color:var(--accent)">毎運行</strong>（1日30〜100回）<br><span style="font-size:0.75rem;color:var(--muted)">営業列車がそのまま検測車に</span></td>
        </tr>
        <tr style="border-bottom:1px solid var(--border)">
          <td style="padding:0.75rem 1rem;font-weight:600">データ確認まで</td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--danger)">数日〜1週間<br><span style="font-size:0.75rem;color:var(--muted)">データ処理・報告書作成</span></td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--safe);font-weight:700">リアルタイム<br><span style="font-size:0.75rem;color:var(--muted)">走行中に即時アラート通知</span></td>
        </tr>
        <tr style="border-bottom:1px solid var(--border);background:rgba(255,255,255,0.02)">
          <td style="padding:0.75rem 1rem;font-weight:600">必要人員</td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--danger)">専門チーム（5〜10名）<br><span style="font-size:0.75rem;color:var(--muted)">深夜作業・熟練技術者</span></td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--safe);font-weight:700">最小限<br><span style="font-size:0.75rem;color:var(--muted)">確認作業のみ（AI が自動スクリーニング）</span></td>
        </tr>
        <tr style="border-bottom:1px solid var(--border)">
          <td style="padding:0.75rem 1rem;font-weight:600">カバレッジ</td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--danger)">路線ごと順番に<br><span style="font-size:0.75rem;color:var(--muted)">優先路線のみ対応しがち</span></td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--safe);font-weight:700">全路線・全区間<br><span style="font-size:0.75rem;color:var(--muted)">車両が走るすべての区間を自動カバー</span></td>
        </tr>
        <tr>
          <td style="padding:0.75rem 1rem;font-weight:600">深夜作業</td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--danger)">必須（終電後）<br><span style="font-size:0.75rem;color:var(--muted)">運転士・保線員の負担大</span></td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--safe);font-weight:700">不要<br><span style="font-size:0.75rem;color:var(--muted)">営業時間内に完結</span></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:2rem">
    <div style="background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;text-align:center">
      <div style="font-size:2.4rem;font-weight:800;color:var(--accent);letter-spacing:-0.02em">30×</div>
      <div style="font-size:0.88rem;font-weight:700;margin-top:0.25rem">点検頻度向上</div>
      <div style="font-size:0.75rem;color:var(--muted);margin-top:0.4rem">月2回 → 毎運行（1日60便）</div>
    </div>
    <div style="background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;text-align:center">
      <div style="font-size:2.4rem;font-weight:800;color:var(--safe);letter-spacing:-0.02em">95%</div>
      <div style="font-size:0.88rem;font-weight:700;margin-top:0.25rem">深夜作業削減</div>
      <div style="font-size:0.75rem;color:var(--muted);margin-top:0.4rem">保線員の労働負荷を大幅軽減</div>
    </div>
    <div style="background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;text-align:center">
      <div style="font-size:2.4rem;font-weight:800;color:var(--indigo);letter-spacing:-0.02em">13ms</div>
      <div style="font-size:0.88rem;font-weight:700;margin-top:0.25rem">1フレーム処理時間</div>
      <div style="font-size:0.75rem;color:var(--muted);margin-top:0.4rem">RTX 4090 実測 · YOLOv8m v2</div>
    </div>
  </div>

  <div style="background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.2);border-radius:var(--radius);padding:1.25rem 1.5rem;font-size:0.85rem;line-height:1.75;color:var(--muted)">
    ※ 比較数値は参考値です。実際のコスト削減効果は路線距離・運行本数・現在の検測体制により異なります。
    詳細な ROI 試算はパイロット導入のご相談時に路線情報に基づいてご提示します。
  </div>
</section>
</div>

<!-- Platform + Whitepaper promo strip -->
<div style="background:var(--surface);border-top:1px solid var(--border);border-bottom:1px solid var(--border);padding:2.5rem 2rem">
  <div style="max-width:1100px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem">

    <a href="railscan-platform.html" style="display:block;text-decoration:none;background:linear-gradient(135deg,rgba(99,102,241,0.08),rgba(99,102,241,0.02));border:1px solid rgba(99,102,241,0.3);border-radius:var(--radius);padding:1.5rem;transition:all 0.2s" onmouseover="this.style.borderColor='rgba(99,102,241,0.6)'" onmouseout="this.style.borderColor='rgba(99,102,241,0.3)'">
      <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem">
        <span style="background:rgba(99,102,241,0.15);border:1px solid rgba(99,102,241,0.3);color:#818cf8;font-size:0.7rem;font-weight:800;padding:2px 8px;border-radius:4px;letter-spacing:0.05em">PLATFORM</span>
      </div>
      <h3 style="font-size:1.1rem;font-weight:800;color:var(--text);margin-bottom:0.4rem">エンタープライズ管理ダッシュボード</h3>
      <p style="font-size:0.83rem;color:var(--muted);line-height:1.6;margin-bottom:0.75rem">8路線 / 2,847km を一元管理。リアルタイムアラート、点検スケジュール、トレンド分析まで全て揃ったエンタープライズUI。</p>
      <span style="font-size:0.82rem;color:#818cf8;font-weight:700">プラットフォームを見る →</span>
    </a>

    <a href="whitepaper.html" style="display:block;text-decoration:none;background:linear-gradient(135deg,rgba(34,197,94,0.06),rgba(34,197,94,0.01));border:1px solid rgba(34,197,94,0.25);border-radius:var(--radius);padding:1.5rem;transition:all 0.2s" onmouseover="this.style.borderColor='rgba(34,197,94,0.5)'" onmouseout="this.style.borderColor='rgba(34,197,94,0.25)'">
      <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem">
        <span style="background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);color:#4ade80;font-size:0.7rem;font-weight:800;padding:2px 8px;border-radius:4px;letter-spacing:0.05em">WHITEPAPER</span>
      </div>
      <h3 style="font-size:1.1rem;font-weight:800;color:var(--text);margin-bottom:0.4rem">技術白書 — システム設計と性能評価</h3>
      <p style="font-size:0.83rem;color:var(--muted);line-height:1.6;margin-bottom:0.75rem">Depth Anything V2 + YOLOv8の詳細アーキテクチャ、モデル比較、統合ガイド。技術担当者向けの詳細ドキュメント。</p>
      <span style="font-size:0.82rem;color:#4ade80;font-weight:700">技術白書を読む →</span>
    </a>

  </div>
</div>

<!-- CTA -->
<div id="cta" class="cta-section">
  <div class="section-label">Contact</div>
  <h2 class="section-title" style="max-width:700px;margin:0 auto 0.75rem">パイロット導入のご相談</h2>
  <p class="section-sub" style="margin:0 auto 2rem">まずは1路線・1編成からの試験導入が可能です。<br>デモンストレーションや技術資料のご提供はお気軽にどうぞ。</p>
  <div style="display:flex;gap:1rem;justify-content:center;flex-wrap:wrap">
    <a href="mailto:founder@spatialforge.dev?subject=RailScan AI 導入相談" class="btn-primary">メールで相談する</a>
    <a href="railscan-platform.html" class="btn-secondary">プラットフォームを見る</a>
    <a href="whitepaper.html" class="btn-secondary">技術白書を読む</a>
    <a href="proposal.html" class="btn-secondary">提案書を見る</a>
  </div>
</div>

<footer>
  <p>&copy; 2026 SpatialForge — AI Railway Track Inspection. Powered by YOLOv8m v2 (mAP@50=44.7%) + Depth Anything V2 Large.</p>
</footer>

<!-- Main application script -->
<script src="js/rail-demo.js"></script>
</body>
</html>
