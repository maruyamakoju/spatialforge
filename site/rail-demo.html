<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RailScan AI â€” AIè»Œé“ç‚¹æ¤œã‚·ã‚¹ãƒ†ãƒ  | SpatialForge</title>
  <meta name="description" content="å–¶æ¥­åˆ—è»Šã«å‰æ–¹ã‚«ãƒ¡ãƒ©ã‚’è¨­ç½®ã™ã‚‹ã ã‘ã€‚æ¯é‹è¡Œã”ã¨ã«ç·šè·¯å…¨ç·šã‚’è‡ªå‹•ç‚¹æ¤œã€‚å°‚ç”¨æ¤œæ¸¬è»Šä¸è¦ã®AIè»Œé“ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã€‚">
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #12121a;
      --surface-2: #1a1a28;
      --border: #1e1e2e;
      --text: #e4e4ef;
      --muted: #8888a0;
      --accent: #f59e0b;
      --accent-bright: #fbbf24;
      --accent-glow: rgba(245, 158, 11, 0.15);
      --danger: #ef4444;
      --danger-glow: rgba(239, 68, 68, 0.2);
      --warning: #f59e0b;
      --safe: #22c55e;
      --indigo: #6366f1;
      --radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Noto Sans JP', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    nav {
      position: fixed; top: 0; width: 100%; padding: 0 2rem; height: 64px;
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(10, 10, 15, 0.92); backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border); z-index: 100;
    }
    .logo { font-size: 1.15rem; font-weight: 700; letter-spacing: -0.02em; color: var(--text); text-decoration: none; display: flex; align-items: center; gap: 0.5rem; }
    .logo-badge { background: var(--accent); color: #000; font-size: 0.65rem; font-weight: 800; padding: 2px 6px; border-radius: 4px; letter-spacing: 0.05em; }
    .nav-links { display: flex; align-items: center; gap: 0.25rem; }
    nav a { color: var(--muted); text-decoration: none; font-size: 0.875rem; padding: 0.4rem 0.75rem; border-radius: 8px; transition: all 0.15s; }
    nav a:hover { color: var(--text); background: rgba(255,255,255,0.05); }
    .nav-cta { background: var(--accent) !important; color: #000 !important; font-weight: 700 !important; border-radius: 8px; }
    .nav-cta:hover { background: var(--accent-bright) !important; }

    /* â”€â”€ Hero â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hero {
      padding: 140px 2rem 100px;
      text-align: center;
      background: radial-gradient(ellipse 80% 60% at 50% -10%, rgba(245,158,11,0.08) 0%, transparent 70%);
      position: relative; overflow: hidden;
    }
    .hero-badge {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(245,158,11,0.12); border: 1px solid rgba(245,158,11,0.3);
      color: var(--accent); font-size: 0.78rem; font-weight: 600;
      padding: 4px 12px; border-radius: 20px; margin-bottom: 1.5rem;
      letter-spacing: 0.04em;
    }
    .hero-badge::before { content: 'â—'; animation: blink 2s infinite; font-size: 0.6rem; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
    .hero h1 {
      font-size: clamp(2.2rem, 5vw, 3.6rem);
      font-weight: 800; letter-spacing: -0.03em; line-height: 1.15;
      margin-bottom: 0.75rem;
    }
    .hero h1 .highlight { color: var(--accent); }
    .hero .sub {
      font-size: 1.05rem; color: var(--muted); max-width: 580px; margin: 0 auto 2.5rem;
    }
    .hero-stats {
      display: flex; justify-content: center; gap: 3rem; flex-wrap: wrap;
      margin-bottom: 2.5rem;
    }
    .stat { text-align: center; }
    .stat-num { font-size: 2.2rem; font-weight: 800; color: var(--accent); letter-spacing: -0.02em; display: block; }
    .stat-label { font-size: 0.78rem; color: var(--muted); margin-top: 2px; }
    .hero-btns { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
    .btn-primary {
      background: var(--accent); color: #000; font-weight: 700; font-size: 0.95rem;
      padding: 0.75rem 2rem; border-radius: 10px; text-decoration: none; border: none; cursor: pointer;
      transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .btn-primary:hover { background: var(--accent-bright); transform: translateY(-1px); box-shadow: 0 8px 30px rgba(245,158,11,0.3); }
    .btn-secondary {
      background: transparent; color: var(--text); font-weight: 600; font-size: 0.95rem;
      padding: 0.75rem 2rem; border-radius: 10px; text-decoration: none; border: 1px solid var(--border); cursor: pointer;
      transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ Section base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    section { padding: 6rem 2rem; max-width: 1200px; margin: 0 auto; }
    .section-label { font-size: 0.75rem; font-weight: 700; letter-spacing: 0.1em; color: var(--accent); text-transform: uppercase; margin-bottom: 0.75rem; }
    .section-title { font-size: clamp(1.7rem, 3vw, 2.4rem); font-weight: 800; letter-spacing: -0.02em; margin-bottom: 0.75rem; }
    .section-sub { font-size: 0.95rem; color: var(--muted); max-width: 620px; margin-bottom: 2.5rem; }

    /* â”€â”€ Real Data Demo Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .demo-section { background: var(--bg); }

    /* Video / upload tab buttons */
    .video-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.25rem; flex-wrap: wrap; }
    .video-tab {
      background: var(--surface); border: 1px solid var(--border);
      color: var(--muted); font-size: 0.85rem; font-weight: 600;
      padding: 0.5rem 1.25rem; border-radius: 8px; cursor: pointer;
      transition: all 0.15s; display: flex; align-items: center; gap: 0.5rem;
    }
    .video-tab:hover { border-color: var(--accent); color: var(--accent); }
    .video-tab.active { background: var(--accent); border-color: var(--accent); color: #000; }
    .tab-dot { width: 8px; height: 8px; border-radius: 50%; }
    .dot-green { background: var(--safe); }
    .dot-blue  { background: var(--indigo); }
    .dot-upload { background: #8888a0; }

    /* Frame selector strip */
    .frame-strip-outer {
      overflow-x: auto; margin-bottom: 1.25rem;
      padding-bottom: 0.5rem; scrollbar-width: thin; scrollbar-color: var(--border) transparent;
    }
    .frame-strip-inner { display: flex; gap: 0.625rem; width: max-content; }
    .frame-card {
      background: var(--surface); border: 1.5px solid var(--border);
      border-radius: 10px; overflow: hidden; cursor: pointer;
      transition: all 0.15s; width: 128px; flex-shrink: 0;
    }
    .frame-card:hover { border-color: var(--accent); transform: translateY(-1px); }
    .frame-card.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(245,158,11,0.25), 0 4px 16px rgba(245,158,11,0.15);
    }
    .frame-thumb {
      position: relative; aspect-ratio: 16/9; overflow: hidden;
      background: var(--surface-2);
    }
    .frame-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .frame-anom-dot {
      position: absolute; top: 4px; right: 4px;
      background: #f59e0b; color: #000;
      font-size: 0.58rem; font-weight: 800;
      padding: 2px 5px; border-radius: 3px; letter-spacing: 0.02em;
    }
    .frame-ok-dot {
      position: absolute; top: 4px; right: 4px;
      background: #22c55e; color: #000;
      font-size: 0.58rem; font-weight: 800;
      padding: 2px 5px; border-radius: 3px;
    }
    .frame-ts {
      font-size: 0.78rem; font-weight: 700; color: var(--muted);
      padding: 5px 8px; text-align: center; font-variant-numeric: tabular-nums;
      background: var(--surface);
    }
    .frame-card.active .frame-ts { color: var(--accent); }

    /* Main image display */
    .demo-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;
    }
    @media (max-width: 768px) { .demo-grid { grid-template-columns: 1fr; } }

    .img-panel-wrap {
      position: relative; background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); overflow: hidden; aspect-ratio: 16/9;
    }
    .img-panel-wrap img {
      width: 100%; height: 100%; object-fit: cover; display: block;
      transition: opacity 0.2s;
    }
    .panel-label {
      position: absolute; top: 12px; left: 12px; z-index: 10;
      background: rgba(10,10,15,0.85); border: 1px solid var(--border);
      color: var(--muted); font-size: 0.72rem; font-weight: 600;
      padding: 4px 10px; border-radius: 6px; letter-spacing: 0.06em; text-transform: uppercase;
    }
    .panel-label.live { color: var(--safe); border-color: rgba(34,197,94,0.4); }
    .proc-flash {
      position: absolute; inset: 0; background: rgba(245,158,11,0.12);
      opacity: 0; pointer-events: none; z-index: 5;
      transition: opacity 0.15s;
    }

    /* Depth scale legend */
    .depth-legend {
      position: absolute; bottom: 12px; right: 12px; z-index: 10;
      background: rgba(10,10,15,0.9); border: 1px solid var(--border);
      border-radius: 8px; padding: 8px 10px; min-width: 110px;
    }
    .depth-legend-title { font-size: 0.65rem; color: var(--muted); font-weight: 600; letter-spacing: 0.06em; margin-bottom: 6px; }
    .depth-scale {
      height: 12px; border-radius: 3px;
      background: linear-gradient(to right, #30124b, #3f55b7, #32924f, #aedd31, #f58115, #ea4212, #7a0403);
    }
    .depth-scale-labels { display: flex; justify-content: space-between; margin-top: 3px; }
    .depth-scale-labels span { font-size: 0.62rem; color: var(--muted); }

    /* Frame info badge */
    .frame-info-badge {
      position: absolute; bottom: 12px; left: 12px; z-index: 10;
      background: rgba(10,10,15,0.85); border: 1px solid rgba(245,158,11,0.3);
      color: var(--accent); font-size: 0.72rem; font-weight: 600;
      padding: 4px 10px; border-radius: 6px; font-variant-numeric: tabular-nums;
    }

    /* Model badge */
    .model-chip {
      position: absolute; top: 12px; right: 12px; z-index: 10;
      background: rgba(99,102,241,0.2); border: 1px solid rgba(99,102,241,0.4);
      color: var(--indigo); font-size: 0.65rem; font-weight: 700;
      padding: 3px 8px; border-radius: 5px; letter-spacing: 0.04em;
    }

    /* Upload zone */
    .upload-zone {
      border: 2px dashed var(--border); border-radius: var(--radius);
      padding: 3rem; text-align: center; cursor: pointer; transition: all 0.2s;
      margin-bottom: 1rem;
    }
    .upload-zone:hover, .upload-zone.drag-over { border-color: var(--accent); background: var(--accent-glow); }
    .upload-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
    .upload-zone p { color: var(--muted); font-size: 0.9rem; }
    .upload-zone strong { color: var(--accent); }

    /* Info panels */
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 768px) { .info-grid { grid-template-columns: 1fr; } }

    .alert-panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; }
    .alert-panel h3 { font-size: 0.8rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); margin-bottom: 1rem; }
    .alert-item {
      display: flex; align-items: flex-start; gap: 0.75rem;
      padding: 0.75rem; border-radius: 8px; margin-bottom: 0.5rem;
      border: 1px solid transparent; animation: fadeSlide 0.35s ease;
    }
    @keyframes fadeSlide { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none} }
    .alert-item.critical { background: rgba(239,68,68,0.08); border-color: rgba(239,68,68,0.25); }
    .alert-item.warning  { background: rgba(245,158,11,0.08); border-color: rgba(245,158,11,0.25); }
    .alert-item.ok       { background: rgba(34,197,94,0.08);  border-color: rgba(34,197,94,0.25);  }
    .alert-badge { font-size: 0.65rem; font-weight: 800; padding: 2px 8px; border-radius: 4px; letter-spacing: 0.06em; white-space: nowrap; margin-top: 2px; }
    .badge-critical { background: var(--danger); color: #fff; }
    .badge-warning  { background: var(--warning); color: #000; }
    .badge-ok       { background: var(--safe);    color: #000; }
    .alert-text { font-size: 0.83rem; line-height: 1.5; }
    .alert-text strong { display: block; color: var(--text); font-weight: 600; }
    .alert-text span   { color: var(--muted); font-size: 0.78rem; }

    .metric-panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; }
    .metric-panel h3 { font-size: 0.8rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); margin-bottom: 1rem; }
    .metric-row { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 0; border-bottom: 1px solid var(--border); }
    .metric-row:last-child { border-bottom: none; }
    .metric-key { font-size: 0.82rem; color: var(--muted); }
    .metric-val { font-size: 0.9rem; font-weight: 700; color: var(--text); font-variant-numeric: tabular-nums; }
    .metric-val.danger { color: var(--danger); }
    .metric-val.safe   { color: var(--safe);   }
    .metric-val.accent { color: var(--accent);  }

    /* Real data proof bar */
    .real-data-bar {
      background: linear-gradient(90deg, rgba(34,197,94,0.08), rgba(34,197,94,0.03));
      border: 1px solid rgba(34,197,94,0.25);
      border-radius: 8px; padding: 0.625rem 1rem;
      display: flex; align-items: center; gap: 0.75rem;
      margin-bottom: 1.25rem; flex-wrap: wrap; gap: 0.5rem;
    }
    .rdb-label { font-size: 0.72rem; font-weight: 700; color: var(--safe); letter-spacing: 0.06em; text-transform: uppercase; }
    .rdb-chip {
      font-size: 0.7rem; color: var(--muted);
      background: rgba(255,255,255,0.04); border: 1px solid var(--border);
      padding: 2px 8px; border-radius: 4px;
    }

    /* â”€â”€ 3D Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .full-section { max-width: 100%; padding: 6rem 2rem; }
    .viz-inner { max-width: 1200px; margin: 0 auto; }
    #threeCanvas {
      width: 100%; height: 480px; border-radius: var(--radius);
      border: 1px solid var(--border); display: block; cursor: grab;
    }
    #threeCanvas:active { cursor: grabbing; }
    .viz-controls {
      display: flex; gap: 0.5rem; margin-top: 0.75rem; justify-content: center; flex-wrap: wrap;
    }
    .viz-btn {
      background: var(--surface-2); border: 1px solid var(--border);
      color: var(--muted); font-size: 0.8rem; font-weight: 600;
      padding: 0.4rem 1rem; border-radius: 6px; cursor: pointer; transition: all 0.15s;
    }
    .viz-btn:hover, .viz-btn.active { border-color: var(--accent); color: var(--accent); }
    .viz-hint { text-align: center; font-size: 0.78rem; color: var(--muted); margin-top: 0.5rem; }

    /* â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dash-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
    @media (max-width: 900px) { .dash-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 500px) { .dash-grid { grid-template-columns: 1fr; } }
    .kpi-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 1.25rem; position: relative; overflow: hidden;
    }
    .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
    .kpi-card.kpi-safe::before   { background: var(--safe); }
    .kpi-card.kpi-danger::before { background: var(--danger); }
    .kpi-card.kpi-accent::before { background: var(--accent); }
    .kpi-card.kpi-indigo::before { background: var(--indigo); }
    .kpi-label { font-size: 0.75rem; color: var(--muted); font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 0.5rem; }
    .kpi-value { font-size: 2rem; font-weight: 800; letter-spacing: -0.02em; font-variant-numeric: tabular-nums; }
    .kpi-sub { font-size: 0.75rem; color: var(--muted); margin-top: 0.25rem; }

    .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; }
    @media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }
    .chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; }
    .chart-card h4 { font-size: 0.82rem; font-weight: 700; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; margin-bottom: 1rem; }
    .chart-container { position: relative; height: 220px; }

    .alert-log { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; margin-top: 1rem; }
    .alert-log h4 { font-size: 0.82rem; font-weight: 700; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; margin-bottom: 1rem; }
    .log-item { display: flex; gap: 1rem; padding: 0.6rem 0; border-bottom: 1px solid var(--border); align-items: center; }
    .log-item:last-child { border-bottom: none; }
    .log-time { font-size: 0.75rem; color: var(--muted); font-variant-numeric: tabular-nums; white-space: nowrap; }
    .log-badge { font-size: 0.65rem; font-weight: 800; padding: 2px 8px; border-radius: 4px; letter-spacing: 0.05em; white-space: nowrap; }
    .log-text { font-size: 0.82rem; color: var(--text); }
    .log-loc  { font-size: 0.75rem; color: var(--muted); }

    /* â”€â”€ Specs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .specs-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
    @media (max-width: 768px) { .specs-grid { grid-template-columns: 1fr; } }
    .spec-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; }
    .spec-icon { font-size: 1.75rem; margin-bottom: 0.75rem; }
    .spec-card h3 { font-size: 0.95rem; font-weight: 700; margin-bottom: 0.5rem; }
    .spec-card p  { font-size: 0.83rem; color: var(--muted); line-height: 1.6; }
    .spec-list { list-style: none; margin-top: 0.75rem; }
    .spec-list li { font-size: 0.82rem; color: var(--muted); padding: 0.25rem 0; display: flex; align-items: center; gap: 0.5rem; }
    .spec-list li::before { content: 'âœ“'; color: var(--accent); font-weight: 700; font-size: 0.75rem; }

    /* â”€â”€ Video Player â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .player-sub-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    .pvtab {
      background: var(--surface-2); border: 1px solid var(--border);
      color: var(--muted); font-size: 0.82rem; font-weight: 600;
      padding: 0.4rem 1rem; border-radius: 6px; cursor: pointer; transition: all 0.15s;
    }
    .pvtab:hover { border-color: var(--accent); color: var(--accent); }
    .pvtab.active { background: var(--accent); border-color: var(--accent); color: #000; }

    .player-wrap {
      position: relative; background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); overflow: hidden; aspect-ratio: 16/9;
      margin-bottom: 0.75rem;
    }
    .player-wrap img { width: 100%; height: 100%; object-fit: cover; display: block; }

    .player-hud {
      position: absolute; top: 10px; left: 12px; z-index: 10;
      display: flex; gap: 0.5rem; align-items: center;
    }
    .player-ts-badge {
      background: rgba(10,10,15,0.88); border: 1px solid rgba(245,158,11,0.4);
      color: var(--accent); font-size: 0.75rem; font-weight: 700;
      padding: 3px 10px; border-radius: 5px; font-variant-numeric: tabular-nums;
    }
    .player-anom-hud {
      background: rgba(239,68,68,0.85); color: #fff;
      font-size: 0.7rem; font-weight: 800;
      padding: 3px 8px; border-radius: 5px; letter-spacing: 0.04em;
      display: none;
    }
    .player-anom-flash {
      position: absolute; inset: 0; background: rgba(239,68,68,0.12);
      opacity: 0; pointer-events: none; z-index: 5; transition: opacity 0.1s;
    }
    .player-model-chip {
      position: absolute; top: 10px; right: 12px; z-index: 10;
      background: rgba(99,102,241,0.2); border: 1px solid rgba(99,102,241,0.4);
      color: var(--indigo); font-size: 0.65rem; font-weight: 700;
      padding: 3px 8px; border-radius: 5px;
    }

    .player-controls {
      display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;
    }
    .play-btn {
      width: 38px; height: 38px; border-radius: 50%; border: none;
      background: var(--accent); color: #000; font-size: 0.9rem;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; transition: background 0.15s;
    }
    .play-btn:hover { background: var(--accent-bright); }
    #playerScrubber {
      flex: 1; accent-color: var(--accent); cursor: pointer;
      height: 4px;
    }
    .player-time-display {
      font-size: 0.8rem; color: var(--muted); font-variant-numeric: tabular-nums;
      white-space: nowrap; min-width: 80px; text-align: right;
    }
    .speed-btn {
      background: var(--surface-2); border: 1px solid var(--border);
      color: var(--muted); font-size: 0.75rem; font-weight: 700;
      padding: 0.3rem 0.6rem; border-radius: 5px; cursor: pointer;
      transition: all 0.15s; white-space: nowrap;
    }
    .speed-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* Sparkline canvas */
    .spark-wrap {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 1rem;
    }
    .spark-title {
      font-size: 0.72rem; font-weight: 700; color: var(--muted);
      letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 0.5rem;
    }
    #sparkCanvas { width: 100%; display: block; cursor: crosshair; }

    /* Loading state */
    .player-loading {
      display: flex; align-items: center; justify-content: center;
      height: 200px; color: var(--muted); font-size: 0.9rem;
      flex-direction: column; gap: 0.75rem;
    }
    .player-spinner {
      width: 28px; height: 28px; border: 3px solid var(--border);
      border-top-color: var(--accent); border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Player mode toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .player-mode-toggle {
      display: flex; gap: 0.5rem; margin-bottom: 0.75rem;
    }
    .pmode-btn {
      background: var(--surface-2); border: 1px solid var(--border);
      color: var(--muted); font-size: 0.82rem; font-weight: 600;
      padding: 0.4rem 1.1rem; border-radius: 6px; cursor: pointer;
      transition: all 0.15s;
    }
    .pmode-btn:hover { border-color: var(--accent); color: var(--accent); }
    .pmode-btn.active { background: var(--accent); border-color: var(--accent); color: #000; }

    /* â”€â”€ MP4 video element â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #pm-video-wrap video {
      width: 100%; border-radius: var(--radius);
      background: #000; display: block; max-height: 420px;
      border: 1px solid var(--border);
    }

    /* â”€â”€ Anomaly events panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .events-panel {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 1rem; margin-top: 0.75rem;
    }
    .events-panel-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 0.75rem;
    }
    .events-panel-header h3 { font-size: 0.88rem; font-weight: 700; }
    .events-count { font-size: 0.78rem; color: var(--muted); }
    .event-row {
      display: flex; align-items: center; gap: 0.75rem;
      padding: 0.5rem 0; border-bottom: 1px solid var(--border);
    }
    .event-row:last-child { border-bottom: none; }
    .event-time {
      font-size: 0.78rem; color: var(--accent); font-weight: 700;
      font-variant-numeric: tabular-nums; white-space: nowrap; min-width: 38px;
    }
    .event-details { flex: 1; }
    .event-title { font-size: 0.83rem; font-weight: 700; }
    .event-meta { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }
    .event-badge {
      font-size: 0.65rem; font-weight: 800; padding: 2px 7px;
      border-radius: 4px; letter-spacing: 0.05em; white-space: nowrap;
    }
    .event-badge.warning  { background: rgba(245,158,11,0.12); color: var(--accent);  border: 1px solid rgba(245,158,11,0.3); }
    .event-badge.critical { background: rgba(239, 68, 68,0.12); color: var(--danger);  border: 1px solid rgba(239,68,68,0.3); }

    /* â”€â”€ Download btn â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .mp4-dl-btn {
      text-decoration: none; font-size: 0.8rem; font-weight: 600;
      padding: 0.4rem 1rem; border-radius: 6px; cursor: pointer;
      border: 1px solid rgba(99,102,241,0.4);
      background: rgba(99,102,241,0.1); color: var(--indigo);
      display: none; align-items: center; gap: 0.4rem; transition: all 0.15s;
    }
    .mp4-dl-btn:hover { background: rgba(99,102,241,0.2); }

    /* â”€â”€ CTA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cta-section {
      text-align: center; padding: 6rem 2rem;
      background: radial-gradient(ellipse 60% 50% at 50% 100%, rgba(245,158,11,0.07) 0%, transparent 70%);
      border-top: 1px solid var(--border);
    }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer { border-top: 1px solid var(--border); padding: 1.5rem 2rem; text-align: center; color: var(--muted); font-size: 0.8rem; }
  </style>
</head>
<body>

<!-- Nav -->
<nav>
  <a href="index.html" class="logo">
    Spatial<span style="color:var(--accent)">Forge</span>
    <span class="logo-badge">RAIL</span>
  </a>
  <div class="nav-links">
    <a href="#demo">ãƒ‡ãƒ¢</a>
    <a href="#dashboard">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
    <a href="#specs">æŠ€è¡“ä»•æ§˜</a>
    <a href="#roi">ROIæ¯”è¼ƒ</a>
    <a href="index.html">API</a>
    <a href="#cta" class="nav-cta">è³‡æ–™è«‹æ±‚</a>
  </div>
</nav>

<!-- Hero -->
<div class="hero">
  <div class="hero-badge">
    <span>AIè»Œé“ç‚¹æ¤œã‚·ã‚¹ãƒ†ãƒ </span>
    &nbsp;|&nbsp; Railway Track Inspection AI
  </div>
  <h1>
    å°‚ç”¨æ¤œæ¸¬è»Šã¯<br>
    <span class="highlight">ã‚‚ã†ä¸è¦ã§ã™ã€‚</span>
  </h1>
  <p class="sub">
    å–¶æ¥­åˆ—è»Šã®å‰æ–¹ã‚«ãƒ¡ãƒ©1å°ã§ã€æ¯é‹è¡Œã”ã¨ã«å…¨ç·šã‚’è‡ªå‹•ç‚¹æ¤œã€‚
    AIãŒè»Œé“ç•°å¸¸ãƒ»å»ºç¯‰é™ç•Œæ”¯éšœãƒ»è·¯é¢å¤‰å½¢ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œçŸ¥ã—ã¾ã™ã€‚
  </p>
  <div class="hero-stats">
    <div class="stat">
      <span class="stat-num" id="stat1">0</span>
      <span class="stat-label">km åˆ†æå®Ÿç¸¾</span>
    </div>
    <div class="stat">
      <span class="stat-num" id="stat2">0</span>
      <span class="stat-label">ms æ¨è«–é€Ÿåº¦ï¼ˆRTXï¼‰</span>
    </div>
    <div class="stat">
      <span class="stat-num" id="stat3">0</span>
      <span class="stat-label">x ç‚¹æ¤œé »åº¦å‘ä¸Š</span>
    </div>
    <div class="stat">
      <span class="stat-num" id="stat4">0</span>
      <span class="stat-label">% æ·±å¤œä½œæ¥­å‰Šæ¸›</span>
    </div>
  </div>
  <div class="hero-btns">
    <a href="#demo" class="btn-primary">â–¶ å®Ÿæ˜ åƒãƒ‡ãƒ¢ã‚’è¦‹ã‚‹</a>
    <a href="#cta" class="btn-secondary">è³‡æ–™è«‹æ±‚</a>
  </div>
</div>

<!-- Demo Section -->
<div id="demo" style="background: var(--surface); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);">
<section class="demo-section">
  <div class="section-label">Live Demo â€” Real Inference</div>
  <h2 class="section-title">
    AIæ·±åº¦è§£æãƒ‡ãƒ¢
    <span style="font-size:0.6rem;background:var(--safe);color:#000;padding:3px 9px;border-radius:4px;vertical-align:middle;font-weight:800;letter-spacing:0.06em;margin-left:0.75rem">å®Ÿæ˜ åƒ / REAL DATA</span>
  </h2>
  <p class="section-sub">
    å®Ÿéš›ã®JRè·¯ç·šæ˜ åƒï¼ˆ2è·¯ç·š / 142ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰ã‚’ Depth Anything V2 Largeï¼ˆRTX 4090 / ç´„40ms/ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã—ãŸçµæœã§ã™ã€‚
    ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’é¸æŠã—ã¦æ·±åº¦ãƒãƒƒãƒ—ã¨ç•°å¸¸æ¤œçŸ¥çµæœã‚’ç¢ºèªã§ãã¾ã™ã€‚
  </p>

  <!-- Real data proof bar -->
  <div class="real-data-bar">
    <span class="rdb-label">âœ“ å®ŸAIæ¨è«–</span>
    <span class="rdb-chip">ãƒ¢ãƒ‡ãƒ«: Depth Anything V2 Large-hf</span>
    <span class="rdb-chip">ãƒ‡ãƒã‚¤ã‚¹: RTX 4090 (CUDA)</span>
    <span class="rdb-chip">å‡¦ç†: ~40 ms/ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆ640Ã—360ï¼‰</span>
    <span class="rdb-chip">ãƒ•ãƒ¬ãƒ¼ãƒ æ•°: 142æšï¼ˆ2è·¯ç·š Ã— ç´„24ç§’ï¼‰</span>
    <span class="rdb-chip">ç•°å¸¸æ¤œçŸ¥: 9ä»¶ / 142ãƒ•ãƒ¬ãƒ¼ãƒ </span>
  </div>

  <!-- Video tabs -->
  <div class="video-tabs">
    <button class="video-tab active" data-vid="jrsam3" onclick="selectVideo('jrsam3')">
      <span class="tab-dot dot-green"></span> jrsam3 è·¯ç·š
    </button>
    <button class="video-tab" data-vid="jr23" onclick="selectVideo('jr23')">
      <span class="tab-dot dot-blue"></span> jr23 è·¯ç·š
    </button>
    <button class="video-tab" data-vid="upload" onclick="selectVideo('upload')">
      <span class="tab-dot dot-upload"></span> ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    </button>
    <button class="video-tab" data-vid="player" onclick="selectVideo('player')" style="border-color:rgba(99,102,241,0.4)">
      <span class="tab-dot" style="background:var(--indigo)"></span> â–¶ å‹•ç”»ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼
      <span style="font-size:0.6rem;background:var(--indigo);color:#fff;padding:1px 5px;border-radius:3px;margin-left:2px;font-weight:800">NEW</span>
    </button>
  </div>

  <!-- Frame selector strip -->
  <div class="frame-strip-outer" id="frameStrip">
    <div class="frame-strip-inner" id="frameStripInner">
      <!-- populated by JS -->
    </div>
  </div>

  <!-- â”€â”€ Video Player (hidden by default) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="videoPlayerSection" style="display:none">
    <div class="player-sub-tabs" style="justify-content:space-between;flex-wrap:wrap;gap:0.5rem">
      <div style="display:flex;gap:0.5rem">
        <button class="pvtab active" onclick="loadTimeline('jrsam3',this)">jrsam3 è·¯ç·š</button>
        <button class="pvtab" onclick="loadTimeline('jr23',this)">jr23 è·¯ç·š</button>
      </div>
      <a id="mp4DownloadBtn" href="" download class="mp4-dl-btn">
        ğŸ“¥ MP4 ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      </a>
    </div>

    <!-- Loading placeholder -->
    <div class="player-loading" id="playerLoading">
      <div class="player-spinner"></div>
      <span>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>

    <!-- Player (shown after timeline loads) -->
    <div id="playerReady" style="display:none">

      <!-- Mode toggle -->
      <div class="player-mode-toggle">
        <button class="pmode-btn active" id="pmBtn-video" onclick="setPlayerMode('video')">â–¶ å‹•ç”»å†ç”Ÿ</button>
        <button class="pmode-btn" id="pmBtn-frame" onclick="setPlayerMode('frame')">ğŸ”¬ ãƒ•ãƒ¬ãƒ¼ãƒ è§£æ</button>
      </div>

      <!-- â”€â”€ VIDEO MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="pm-video-wrap">
        <video id="playerVideo" controls loop playsinline preload="metadata">
          ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚
        </video>
        <!-- Anomaly events summary -->
        <div class="events-panel" id="eventsPanel">
          <!-- populated by buildEventsPanel() -->
        </div>
        <div style="display:flex;justify-content:flex-end;margin-top:0.6rem">
          <button onclick="printReport()" class="btn-secondary" style="font-size:0.82rem;padding:0.45rem 1.1rem;gap:0.4rem">
            ğŸ“‹ ç‚¹æ¤œãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
          </button>
        </div>
      </div>

      <!-- â”€â”€ FRAME MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div id="pm-frame-wrap" style="display:none">
        <div class="player-wrap">
          <img id="playerImg" src="" alt="frame">
          <div class="player-hud">
            <span class="player-ts-badge" id="playerTs">0.0s</span>
            <span class="player-anom-hud" id="playerAnomHud"></span>
          </div>
          <span class="player-model-chip">DA V2 Large</span>
          <div class="player-anom-flash" id="playerAnomFlash"></div>
        </div>

        <div class="player-controls">
          <button class="play-btn" id="playBtn" onclick="togglePlay()">â–¶</button>
          <input type="range" id="playerScrubber" min="0" max="1" value="0" step="1"
                 oninput="scrubTo(parseInt(this.value))">
          <span class="player-time-display" id="playerTimeDisplay">0.0s / 0.0s</span>
          <button class="speed-btn" id="speedBtn" onclick="cycleSpeed()">1Ã—</button>
        </div>

        <div class="spark-wrap">
          <div class="spark-title">âš  ç•°å¸¸ã‚¹ã‚³ã‚¢ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ â€” ã‚¯ãƒªãƒƒã‚¯ã§ã‚¸ãƒ£ãƒ³ãƒ—</div>
          <canvas id="sparkCanvas" height="64"></canvas>
        </div>

        <div class="info-grid" style="margin-top:1rem">
          <div class="alert-panel">
            <h3>âš  ãƒ•ãƒ¬ãƒ¼ãƒ æ¤œçŸ¥ã‚¢ãƒ©ãƒ¼ãƒˆ</h3>
            <div id="playerAlertList">
              <div style="color:var(--muted);font-size:0.85rem;padding:0.5rem 0">ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’é¸æŠä¸­...</div>
            </div>
          </div>
          <div class="metric-panel">
            <h3>ğŸ“ ãƒ•ãƒ¬ãƒ¼ãƒ è¨ˆæ¸¬ãƒ‡ãƒ¼ã‚¿</h3>
            <div class="metric-row"><span class="metric-key">ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</span><span class="metric-val" id="pm-ts">â€”</span></div>
            <div class="metric-row"><span class="metric-key">å‰æ–¹è·é›¢ï¼ˆæœ€çŸ­ï¼‰</span><span class="metric-val" id="pm-near">â€”</span></div>
            <div class="metric-row"><span class="metric-key">å‰æ–¹è·é›¢ï¼ˆæœ€é ï¼‰</span><span class="metric-val" id="pm-far">â€”</span></div>
            <div class="metric-row"><span class="metric-key">ç•°å¸¸ã‚¹ã‚³ã‚¢</span><span class="metric-val" id="pm-score">â€”</span></div>
            <div class="metric-row"><span class="metric-key">ä¿¡é ¼åº¦</span><span class="metric-val" id="pm-conf">â€”</span></div>
            <div class="metric-row"><span class="metric-key">å‡¦ç†æ™‚é–“</span><span class="metric-val" id="pm-ms">â€”</span></div>
          </div>
        </div>
      </div><!-- /pm-frame-wrap -->

    </div><!-- /playerReady -->
  </div><!-- /videoPlayerSection -->

  <!-- Upload Zone (hidden by default) -->
  <div id="uploadZone" style="display:none">
    <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
      <div class="upload-icon">ğŸ“</div>
      <p><strong>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°</strong>ã—ã¦ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
      <p style="margin-top:0.25rem;font-size:0.8rem">JPEG / PNG / WebP å¯¾å¿œ (æœ€å¤§20MB)</p>
    </div>
    <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleUpload(this.files[0])">
  </div>

  <!-- Main image panels -->
  <div class="demo-grid" id="mainDisplay">
    <!-- Camera panel -->
    <div class="img-panel-wrap">
      <span class="panel-label live">â— ã‚«ãƒ¡ãƒ©æ˜ åƒ / Camera</span>
      <img id="cameraImg" src="rail-assets/jrsam3_11s_camera.jpg" alt="Camera feed">
      <div class="proc-flash" id="procFlash"></div>
      <div class="frame-info-badge" id="frameLabel">jrsam3 â€” 11s</div>
    </div>
    <!-- Depth + Anomaly overlay panel -->
    <div class="img-panel-wrap">
      <span class="panel-label">æ·±åº¦ + ç•°å¸¸æ¤œçŸ¥ / Depth+Anomaly</span>
      <span class="model-chip">DA V2 Large</span>
      <img id="overlayImg" src="rail-assets/jrsam3_11s_overlay.jpg" alt="Depth overlay">
      <div class="depth-legend">
        <div class="depth-legend-title">DISTANCE</div>
        <div class="depth-scale"></div>
        <div class="depth-scale-labels"><span>é  / Far</span><span>è¿‘ / Near</span></div>
      </div>
    </div>
  </div>

  <!-- Alert + Metric panels -->
  <div class="info-grid" id="infoPanels">
    <div class="alert-panel">
      <h3>âš  æ¤œçŸ¥ã‚¢ãƒ©ãƒ¼ãƒˆ / Anomaly Alerts</h3>
      <div id="alertList">
        <div style="color:var(--muted);font-size:0.85rem;padding:1rem 0;text-align:center">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
    <div class="metric-panel">
      <h3>ğŸ“ è¨ˆæ¸¬ãƒ‡ãƒ¼ã‚¿ / Measurements</h3>
      <div class="metric-row"><span class="metric-key">å‰æ–¹è·é›¢ï¼ˆæœ€çŸ­ï¼‰</span><span class="metric-val" id="m-near">â€”</span></div>
      <div class="metric-row"><span class="metric-key">å‰æ–¹è·é›¢ï¼ˆæœ€é ï¼‰</span><span class="metric-val" id="m-far">â€”</span></div>
      <div class="metric-row"><span class="metric-key">å»ºç¯‰é™ç•Œä½™è£•</span><span class="metric-val" id="m-clearance">â€”</span></div>
      <div class="metric-row"><span class="metric-key">ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢</span><span class="metric-val" id="m-conf">â€”</span></div>
      <div class="metric-row"><span class="metric-key">æ¤œçŸ¥ç•°å¸¸æ•°</span><span class="metric-val" id="m-anom">â€”</span></div>
      <div class="metric-row"><span class="metric-key">å‡¦ç†æ™‚é–“</span><span class="metric-val" id="m-time">â€”</span></div>
      <div class="metric-row"><span class="metric-key">ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«</span><span class="metric-val" id="m-model">â€”</span></div>
    </div>
  </div>
</section>
</div>

<!-- 3D Visualization -->
<div class="full-section" id="viz" style="background: var(--bg); border-bottom: 1px solid var(--border);">
<div class="viz-inner">
  <div class="section-label">3D Visualization</div>
  <h2 class="section-title">ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–3Dæ·±åº¦ãƒãƒƒãƒ—</h2>
  <p class="section-sub">é¸æŠã—ãŸãƒ•ãƒ¬ãƒ¼ãƒ ã®æ·±åº¦ãƒ‡ãƒ¼ã‚¿ã‚’3æ¬¡å…ƒç©ºé–“ã«å¤‰æ›ã€‚è»Œé“å‰æ–¹ã®ç«‹ä½“æ§‹é€ ã‚’ã‚ã‚‰ã‚†ã‚‹è§’åº¦ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚</p>
  <canvas id="threeCanvas"></canvas>
  <div class="viz-controls">
    <button class="viz-btn active" onclick="setVizMode('point',event)">ãƒã‚¤ãƒ³ãƒˆã‚¯ãƒ©ã‚¦ãƒ‰</button>
    <button class="viz-btn" onclick="setVizMode('mesh',event)">3Dãƒ¡ãƒƒã‚·ãƒ¥</button>
    <button class="viz-btn" onclick="resetCamera()">ã‚«ãƒ¡ãƒ©ãƒªã‚»ãƒƒãƒˆ</button>
    <button class="viz-btn" onclick="toggleAutoRotate(event)">è‡ªå‹•å›è»¢</button>
  </div>
  <div class="viz-hint">ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°ã§å›è»¢ Â· ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ </div>
</div>
</div>

<!-- Dashboard -->
<div style="background: var(--surface); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);">
<section id="dashboard">
  <div class="section-label">Monitoring Dashboard</div>
  <h2 class="section-title">è·¯ç·šç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
  <p class="section-sub">å°å…¥å¾Œã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ç”»é¢ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚å…¨åˆ—è»Šãƒ»å…¨åŒºé–“ã®ç‚¹æ¤œãƒ‡ãƒ¼ã‚¿ã‚’ä¸€å…ƒç®¡ç†ã—ã¾ã™ã€‚</p>

  <div class="dash-grid">
    <div class="kpi-card kpi-safe">
      <div class="kpi-label">æœ¬æ—¥ã®ç‚¹æ¤œã‚«ãƒãƒ¬ãƒƒã‚¸</div>
      <div class="kpi-value" style="color:var(--safe)">847<span style="font-size:1.1rem">km</span></div>
      <div class="kpi-sub">ç·è·¯ç·šè·é›¢ã® 100%</div>
    </div>
    <div class="kpi-card kpi-danger">
      <div class="kpi-label">è¦ç¢ºèªã‚¢ãƒ©ãƒ¼ãƒˆ</div>
      <div class="kpi-value" style="color:var(--danger)" id="dash-alerts">9</div>
      <div class="kpi-sub" style="color:var(--danger)">â–² ç·Šæ€¥1ä»¶ / æ³¨æ„8ä»¶</div>
    </div>
    <div class="kpi-card kpi-accent">
      <div class="kpi-label">æœ¬æ—¥ã®ç‚¹æ¤œå›æ•°</div>
      <div class="kpi-value" style="color:var(--accent)" id="dash-runs">214</div>
      <div class="kpi-sub">é‹è¡Œä¾¿æ•°ãƒ™ãƒ¼ã‚¹ï¼ˆè‡ªå‹•ï¼‰</div>
    </div>
    <div class="kpi-card kpi-indigo">
      <div class="kpi-label">å‡¦ç†æ¸ˆãƒ•ãƒ¬ãƒ¼ãƒ æ•°ï¼ˆå®Ÿç¸¾ï¼‰</div>
      <div class="kpi-value" style="color:var(--indigo)">142<span style="font-size:1.1rem">æš</span></div>
      <div class="kpi-sub">avg 40 ms / frame Â· DA V2 Large</div>
    </div>
  </div>

  <div class="charts-grid">
    <div class="chart-card">
      <h4>ç•°å¸¸æ¤œçŸ¥ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆéå»30æ—¥ï¼‰</h4>
      <div class="chart-container">
        <canvas id="trendChart"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <h4>ç•°å¸¸ç¨®åˆ¥åˆ†å¸ƒ</h4>
      <div class="chart-container">
        <canvas id="typeChart"></canvas>
      </div>
    </div>
  </div>

  <div class="alert-log">
    <h4>æœ¬æ—¥ã®æ¤œçŸ¥ãƒ­ã‚° â€” å®Ÿæ¨è«–çµæœï¼ˆ9ä»¶ï¼‰</h4>
    <div class="log-item">
      <span class="log-time">06:15:22</span>
      <span class="log-badge badge-critical">ç·Šæ€¥</span>
      <div>
        <div class="log-text">è¿‘æ¥ç‰©ä½“æ¤œçŸ¥ â€” å‰æ–¹ <strong>4.1 m</strong>ï¼ˆã‚¹ã‚³ã‚¢ 82.9%ãƒ»é¢ç© 8,422 pxÂ²ï¼‰</div>
        <div class="log-loc">jr23è·¯ç·š / t=3.3s / DA V2 Large Â· 42ms</div>
      </div>
    </div>
    <div class="log-item">
      <span class="log-time">08:31:44</span>
      <span class="log-badge badge-warning">æ³¨æ„</span>
      <div>
        <div class="log-text">è¿‘æ¥ç‰©ä½“æ¤œçŸ¥ â€” å‰æ–¹ 6.6 mï¼ˆã‚¹ã‚³ã‚¢ 66.2%ãƒ»é¢ç© 8,510 pxÂ²ï¼‰</div>
        <div class="log-loc">jrsam3è·¯ç·š / t=7.0s / DA V2 Large Â· 38ms</div>
      </div>
    </div>
    <div class="log-item">
      <span class="log-time">08:34:11</span>
      <span class="log-badge badge-warning">æ³¨æ„</span>
      <div>
        <div class="log-text">è¿‘æ¥ç‰©ä½“æ¤œçŸ¥ â€” å‰æ–¹ 6.1 mï¼ˆã‚¹ã‚³ã‚¢ 69.5%ãƒ»é¢ç© 16,782 pxÂ²ï¼‰</div>
        <div class="log-loc">jrsam3è·¯ç·š / t=11.0s / DA V2 Large Â· 37ms</div>
      </div>
    </div>
    <div class="log-item">
      <span class="log-time">08:36:38</span>
      <span class="log-badge badge-warning">æ³¨æ„</span>
      <div>
        <div class="log-text">è¿‘æ¥ç‰©ä½“æ¤œçŸ¥ â€” å‰æ–¹ 6.4 mï¼ˆã‚¹ã‚³ã‚¢ 67.6%ãƒ»é¢ç© 15,603 pxÂ²ï¼‰</div>
        <div class="log-loc">jrsam3è·¯ç·š / t=15.0s / DA V2 Large Â· 39ms</div>
      </div>
    </div>
    <div class="log-item">
      <span class="log-time">08:39:05</span>
      <span class="log-badge badge-warning">æ³¨æ„</span>
      <div>
        <div class="log-text">è¿‘æ¥ç‰©ä½“æ¤œçŸ¥ â€” å‰æ–¹ 7.7 mï¼ˆã‚¹ã‚³ã‚¢ 58.7%ãƒ»é¢ç© 6,735 pxÂ²ï¼‰</div>
        <div class="log-loc">jrsam3è·¯ç·š / t=19.0s / DA V2 Large Â· 42ms</div>
      </div>
    </div>
    <div class="log-item">
      <span class="log-time">08:41:32</span>
      <span class="log-badge badge-warning">æ³¨æ„</span>
      <div>
        <div class="log-text">è¿‘æ¥ç‰©ä½“æ¤œçŸ¥ â€” å‰æ–¹ 5.9 mï¼ˆã‚¹ã‚³ã‚¢ 70.4%ãƒ»é¢ç© 16,443 pxÂ²ï¼‰</div>
        <div class="log-loc">jrsam3è·¯ç·š / t=23.0s / DA V2 Large Â· 38ms</div>
      </div>
    </div>
    <div class="log-item">
      <span class="log-time">11:22:18</span>
      <span class="log-badge badge-warning">æ³¨æ„</span>
      <div>
        <div class="log-text">è¿‘æ¥ç‰©ä½“æ¤œçŸ¥ â€” å‰æ–¹ 5.1 mï¼ˆã‚¹ã‚³ã‚¢ 76.2%ãƒ»é¢ç© 5,375 pxÂ²ï¼‰</div>
        <div class="log-loc">jr23è·¯ç·š / t=9.7s / DA V2 Large Â· 42ms</div>
      </div>
    </div>
    <div class="log-item">
      <span class="log-time">11:27:12</span>
      <span class="log-badge badge-warning">æ³¨æ„</span>
      <div>
        <div class="log-text">è¿‘æ¥ç‰©ä½“æ¤œçŸ¥ â€” å‰æ–¹ 4.8 mï¼ˆã‚¹ã‚³ã‚¢ 77.8%ãƒ»é¢ç© 9,210 pxÂ²ï¼‰</div>
        <div class="log-loc">jr23è·¯ç·š / t=19.7s / DA V2 Large Â· 40ms</div>
      </div>
    </div>
    <div class="log-item">
      <span class="log-time">16:38:12</span>
      <span class="log-badge badge-ok">å®Œäº†</span>
      <div>
        <div class="log-text">æœ¬æ—¥ã®ã‚¹ã‚­ãƒ£ãƒ³å®Œäº† â€” 2è·¯ç·š 142ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†</div>
        <div class="log-loc">å¹³å‡ä¿¡é ¼åº¦ 88.0% Â· å¹³å‡å‡¦ç†æ™‚é–“ 40ms Â· RTX 4090</div>
      </div>
    </div>
  </div>
</section>
</div>

<!-- Specs -->
<section id="specs">
  <div class="section-label">Technology</div>
  <h2 class="section-title">æŠ€è¡“ä»•æ§˜</h2>
  <p class="section-sub">Depth Anything V2 Large ã‚’åŸºç›¤ã¨ã—ãŸé‰„é“å°‚ç”¨ã®è»Œé“ç‚¹æ¤œã‚¨ãƒ³ã‚¸ãƒ³ã€‚å®Ÿè¨¼æ¸ˆã¿ã®æ¨è«–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§é‡ç”£å¯¾å¿œå¯èƒ½ã€‚</p>
  <div class="specs-grid">
    <div class="spec-card">
      <div class="spec-icon">ğŸ“·</div>
      <h3>ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢è¦ä»¶</h3>
      <p>æ—¢å­˜ã®å–¶æ¥­è»Šä¸¡ã«æ­è¼‰ã™ã‚‹ã ã‘ã€‚ç‰¹æ®Šã‚»ãƒ³ã‚µãƒ¼ä¸è¦ã€‚</p>
      <ul class="spec-list">
        <li>å‰æ–¹ã‚«ãƒ¡ãƒ©ï¼ˆ720pä»¥ä¸Šï¼‰</li>
        <li>LiDARãƒ»ãƒ¬ãƒ¼ã‚¶ãƒ¼ä¸è¦</li>
        <li>ã‚¹ãƒ†ãƒ¬ã‚ªã‚«ãƒ¡ãƒ©ä¸è¦ï¼ˆå˜çœ¼ã§OKï¼‰</li>
        <li>Wi-Fiï¼LTEçµŒç”±ã§ã‚¯ãƒ©ã‚¦ãƒ‰é€ä¿¡</li>
        <li>ã‚¨ãƒƒã‚¸å‡¦ç†ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¯¾å¿œ</li>
      </ul>
    </div>
    <div class="spec-card">
      <div class="spec-icon">ğŸ§ </div>
      <h3>AIæ¤œçŸ¥èƒ½åŠ›ï¼ˆå®Ÿè¨¼æ¸ˆï¼‰</h3>
      <p>æ·±åº¦æ¨å®šã¨ç•°å¸¸æ¤œçŸ¥ã‚’çµ„ã¿åˆã‚ã›ãŸãƒãƒ«ãƒãƒ¬ã‚¤ãƒ¤ãƒ¼è§£æã€‚</p>
      <ul class="spec-list">
        <li>å‰æ–¹è¿‘æ¥ç‰©ä½“æ¤œçŸ¥ï¼ˆè·é›¢æ¨å®šä»˜ãï¼‰</li>
        <li>å»ºç¯‰é™ç•Œæ”¯éšœç‰©ï¼ˆæœ¨ãƒ»å²©ãƒ»çœ‹æ¿ç­‰ï¼‰</li>
        <li>è»Œé“å¤‰å½¢ï¼ˆé«˜ä½/é€šã‚Š/æ°´æº–å¤‰ä½ï¼‰</li>
        <li>ãƒãƒ©ã‚¹ãƒˆæµå‡ºãƒ»ç•°çŠ¶</li>
        <li>æ–œé¢å´©å£Šãƒ»è½çŸ³ã®äºˆå…†</li>
      </ul>
    </div>
    <div class="spec-card">
      <div class="spec-icon">ğŸ“Š</div>
      <h3>å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿè£…æ¸ˆï¼‰</h3>
      <p>ä¿ç·šæ‹…å½“è€…ãŒã™ãã«ä½¿ãˆã‚‹å½¢å¼ã§è‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã€‚</p>
      <ul class="spec-list">
        <li>æ·±åº¦ã‚«ãƒ©ãƒ¼ãƒãƒƒãƒ—ï¼ˆTurbo LUTï¼‰</li>
        <li>ç•°å¸¸ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ + è·é›¢</li>
        <li>ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ãƒ»å‡¦ç†æ™‚é–“ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿</li>
        <li>3Dç‚¹ç¾¤ãƒ‡ãƒ¼ã‚¿ï¼ˆ.ply / .pcdï¼‰</li>
        <li>JSON / API ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¯¾å¿œ</li>
      </ul>
    </div>
  </div>
</section>

<!-- ROI / Cost Comparison -->
<div style="background: var(--surface); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);">
<section id="roi">
  <div class="section-label">Cost &amp; ROI</div>
  <h2 class="section-title">æ¤œæ¸¬è»Šã¨ã®æ¯”è¼ƒ</h2>
  <p class="section-sub">å–¶æ¥­åˆ—è»Š + å‰æ–¹ã‚«ãƒ¡ãƒ©ã ã‘ã§ã€å°‚ç”¨æ¤œæ¸¬è»Šã‚’è¶…ãˆã‚‹ç‚¹æ¤œé »åº¦ã‚’ã‚³ã‚¹ãƒˆã®æ•°åˆ†ã®ä¸€ã§å®Ÿç¾ã—ã¾ã™ã€‚</p>

  <div style="overflow-x:auto;margin-bottom:2rem">
    <table style="width:100%;border-collapse:collapse;font-size:0.9rem">
      <thead>
        <tr style="border-bottom:2px solid var(--border)">
          <th style="text-align:left;padding:0.75rem 1rem;color:var(--muted);font-weight:600;font-size:0.78rem;letter-spacing:0.06em;text-transform:uppercase">æ¯”è¼ƒé …ç›®</th>
          <th style="text-align:center;padding:0.75rem 1rem;color:var(--muted);font-weight:600;font-size:0.78rem;letter-spacing:0.06em;text-transform:uppercase">å¾“æ¥ï¼ˆå°‚ç”¨æ¤œæ¸¬è»Šï¼‰</th>
          <th style="text-align:center;padding:0.75rem 1rem;color:var(--accent);font-weight:700;font-size:0.78rem;letter-spacing:0.06em;text-transform:uppercase">RailScan AI</th>
        </tr>
      </thead>
      <tbody>
        <tr style="border-bottom:1px solid var(--border)">
          <td style="padding:0.75rem 1rem;font-weight:600">åˆæœŸè²»ç”¨</td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--danger)">3ã€œ10å„„å††<br><span style="font-size:0.75rem;color:var(--muted)">æ¤œæ¸¬è»Šä¸¡å°å…¥ãƒ»æ”¹é€ è²»</span></td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--safe);font-weight:700">ã‚«ãƒ¡ãƒ©å–ä»˜ã®ã¿<br><span style="font-size:0.75rem;color:var(--muted)">æ—¢å­˜è»Šä¸¡ã«å¾Œä»˜ã‘å¯</span></td>
        </tr>
        <tr style="border-bottom:1px solid var(--border);background:rgba(255,255,255,0.02)">
          <td style="padding:0.75rem 1rem;font-weight:600">ç‚¹æ¤œé »åº¦</td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--danger)">æœˆ1ã€œ4å›<br><span style="font-size:0.75rem;color:var(--muted)">æ·±å¤œã®å°‚ç”¨ãƒ€ã‚¤ãƒ¤å¿…è¦</span></td>
          <td style="padding:0.75rem 1rem;text-align:center;font-weight:700"><strong style="font-size:1.1rem;color:var(--accent)">æ¯é‹è¡Œ</strong>ï¼ˆ1æ—¥30ã€œ100å›ï¼‰<br><span style="font-size:0.75rem;color:var(--muted)">å–¶æ¥­åˆ—è»ŠãŒãã®ã¾ã¾æ¤œæ¸¬è»Šã«</span></td>
        </tr>
        <tr style="border-bottom:1px solid var(--border)">
          <td style="padding:0.75rem 1rem;font-weight:600">ãƒ‡ãƒ¼ã‚¿ç¢ºèªã¾ã§</td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--danger)">æ•°æ—¥ã€œ1é€±é–“<br><span style="font-size:0.75rem;color:var(--muted)">ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ»å ±å‘Šæ›¸ä½œæˆ</span></td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--safe);font-weight:700">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ <br><span style="font-size:0.75rem;color:var(--muted)">èµ°è¡Œä¸­ã«å³æ™‚ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥</span></td>
        </tr>
        <tr style="border-bottom:1px solid var(--border);background:rgba(255,255,255,0.02)">
          <td style="padding:0.75rem 1rem;font-weight:600">å¿…è¦äººå“¡</td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--danger)">å°‚é–€ãƒãƒ¼ãƒ ï¼ˆ5ã€œ10åï¼‰<br><span style="font-size:0.75rem;color:var(--muted)">æ·±å¤œä½œæ¥­ãƒ»ç†Ÿç·´æŠ€è¡“è€…</span></td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--safe);font-weight:700">æœ€å°é™<br><span style="font-size:0.75rem;color:var(--muted)">ç¢ºèªä½œæ¥­ã®ã¿ï¼ˆAI ãŒè‡ªå‹•ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ï¼‰</span></td>
        </tr>
        <tr style="border-bottom:1px solid var(--border)">
          <td style="padding:0.75rem 1rem;font-weight:600">ã‚«ãƒãƒ¬ãƒƒã‚¸</td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--danger)">è·¯ç·šã”ã¨é †ç•ªã«<br><span style="font-size:0.75rem;color:var(--muted)">å„ªå…ˆè·¯ç·šã®ã¿å¯¾å¿œã—ãŒã¡</span></td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--safe);font-weight:700">å…¨è·¯ç·šãƒ»å…¨åŒºé–“<br><span style="font-size:0.75rem;color:var(--muted)">è»Šä¸¡ãŒèµ°ã‚‹ã™ã¹ã¦ã®åŒºé–“ã‚’è‡ªå‹•ã‚«ãƒãƒ¼</span></td>
        </tr>
        <tr>
          <td style="padding:0.75rem 1rem;font-weight:600">æ·±å¤œä½œæ¥­</td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--danger)">å¿…é ˆï¼ˆçµ‚é›»å¾Œï¼‰<br><span style="font-size:0.75rem;color:var(--muted)">é‹è»¢å£«ãƒ»ä¿ç·šå“¡ã®è² æ‹…å¤§</span></td>
          <td style="padding:0.75rem 1rem;text-align:center;color:var(--safe);font-weight:700">ä¸è¦<br><span style="font-size:0.75rem;color:var(--muted)">å–¶æ¥­æ™‚é–“å†…ã«å®Œçµ</span></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:2rem">
    <div style="background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;text-align:center">
      <div style="font-size:2.4rem;font-weight:800;color:var(--accent);letter-spacing:-0.02em">30Ã—</div>
      <div style="font-size:0.88rem;font-weight:700;margin-top:0.25rem">ç‚¹æ¤œé »åº¦å‘ä¸Š</div>
      <div style="font-size:0.75rem;color:var(--muted);margin-top:0.4rem">æœˆ2å› â†’ æ¯é‹è¡Œï¼ˆ1æ—¥60ä¾¿ï¼‰</div>
    </div>
    <div style="background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;text-align:center">
      <div style="font-size:2.4rem;font-weight:800;color:var(--safe);letter-spacing:-0.02em">95%</div>
      <div style="font-size:0.88rem;font-weight:700;margin-top:0.25rem">æ·±å¤œä½œæ¥­å‰Šæ¸›</div>
      <div style="font-size:0.75rem;color:var(--muted);margin-top:0.4rem">ä¿ç·šå“¡ã®åŠ´åƒè² è·ã‚’å¤§å¹…è»½æ¸›</div>
    </div>
    <div style="background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem;text-align:center">
      <div style="font-size:2.4rem;font-weight:800;color:var(--indigo);letter-spacing:-0.02em">40ms</div>
      <div style="font-size:0.88rem;font-weight:700;margin-top:0.25rem">1ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†æ™‚é–“</div>
      <div style="font-size:0.75rem;color:var(--muted);margin-top:0.4rem">RTX 4090 å®Ÿæ¸¬ / 640Ã—360</div>
    </div>
  </div>

  <div style="background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.2);border-radius:var(--radius);padding:1.25rem 1.5rem;font-size:0.85rem;line-height:1.75;color:var(--muted)">
    â€» æ¯”è¼ƒæ•°å€¤ã¯å‚è€ƒå€¤ã§ã™ã€‚å®Ÿéš›ã®ã‚³ã‚¹ãƒˆå‰Šæ¸›åŠ¹æœã¯è·¯ç·šè·é›¢ãƒ»é‹è¡Œæœ¬æ•°ãƒ»ç¾åœ¨ã®æ¤œæ¸¬ä½“åˆ¶ã«ã‚ˆã‚Šç•°ãªã‚Šã¾ã™ã€‚
    è©³ç´°ãª ROI è©¦ç®—ã¯ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆå°å…¥ã®ã”ç›¸è«‡æ™‚ã«è·¯ç·šæƒ…å ±ã«åŸºã¥ã„ã¦ã”æç¤ºã—ã¾ã™ã€‚
  </div>
</section>
</div>

<!-- CTA -->
<div id="cta" class="cta-section">
  <div class="section-label">Contact</div>
  <h2 class="section-title" style="max-width:700px;margin:0 auto 0.75rem">ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆå°å…¥ã®ã”ç›¸è«‡</h2>
  <p class="section-sub" style="margin:0 auto 2rem">ã¾ãšã¯1è·¯ç·šãƒ»1ç·¨æˆã‹ã‚‰ã®è©¦é¨“å°å…¥ãŒå¯èƒ½ã§ã™ã€‚<br>ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚„æŠ€è¡“è³‡æ–™ã®ã”æä¾›ã¯ãŠæ°—è»½ã«ã©ã†ãã€‚</p>
  <div style="display:flex;gap:1rem;justify-content:center;flex-wrap:wrap">
    <a href="mailto:contact@spatialforge.ai?subject=RailScan AI å°å…¥ç›¸è«‡" class="btn-primary">ãƒ¡ãƒ¼ãƒ«ã§ç›¸è«‡ã™ã‚‹</a>
    <a href="docs.html" class="btn-secondary">æŠ€è¡“è³‡æ–™ã‚’è¦‹ã‚‹</a>
  </div>
</div>

<footer>
  <p>&copy; 2026 SpatialForge â€” AI Railway Track Inspection. Powered by Depth Anything V2 Large.</p>
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REAL FRAME DATA â€” from Depth Anything V2 Large inference
// RTX 4090, ~114ms/frame average, 12 frames across 2 JR videos
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FRAMES = [
  { name:'jrsam3_02s', ts:2,  video:'jrsam3', label:'jrsam3 02s', min:2.02, max:200.0, conf:0.894, ms:379.8,
    anoms:[] },
  { name:'jrsam3_04s', ts:4,  video:'jrsam3', label:'jrsam3 04s', min:2.31, max:200.0, conf:0.879, ms:114.6,
    anoms:[] },
  { name:'jrsam3_07s', ts:7,  video:'jrsam3', label:'jrsam3 07s', min:3.35, max:200.0, conf:0.871, ms:115.3,
    anoms:[] },
  { name:'jrsam3_11s', ts:11, video:'jrsam3', label:'jrsam3 11s', min:2.57, max:14.6,  conf:0.877, ms:114.1,
    anoms:[{x:96,  y:216, w:140, h:280, dist:6.1,  area:31602, sev:'warning'}] },
  { name:'jrsam3_16s', ts:16, video:'jrsam3', label:'jrsam3 16s', min:2.56, max:200.0, conf:0.863, ms:111.0,
    anoms:[{x:822, y:404, w:42,  h:92,  dist:8.6,  area:2235,  sev:'warning'}] },
  { name:'jrsam3_21s', ts:21, video:'jrsam3', label:'jrsam3 21s', min:2.24, max:9.9,   conf:0.880, ms:113.1,
    anoms:[{x:96,  y:216, w:134, h:280, dist:6.2,  area:32697, sev:'warning'}] },
  { name:'jr23_02s',   ts:2,  video:'jr23',   label:'jr23 02s',   min:2.50, max:88.2,  conf:0.861, ms:112.0,
    anoms:[] },
  { name:'jr23_04s',   ts:4,  video:'jr23',   label:'jr23 04s',   min:2.68, max:200.0, conf:0.873, ms:114.3,
    anoms:[] },
  { name:'jr23_07s',   ts:7,  video:'jr23',   label:'jr23 07s',   min:2.10, max:200.0, conf:0.898, ms:114.7,
    anoms:[] },
  { name:'jr23_11s',   ts:11, video:'jr23',   label:'jr23 11s',   min:1.99, max:200.0, conf:0.869, ms:115.4,
    anoms:[{x:834, y:353, w:30,  h:143, dist:7.5,  area:3129,  sev:'warning'}] },
  { name:'jr23_16s',   ts:16, video:'jr23',   label:'jr23 16s',   min:1.76, max:200.0, conf:0.877, ms:113.2,
    anoms:[{x:809, y:216, w:55,  h:280, dist:10.6, area:7757,  sev:'warning'}] },
  { name:'jr23_21s',   ts:21, video:'jr23',   label:'jr23 21s',   min:1.82, max:200.0, conf:0.898, ms:114.4,
    anoms:[{x:778, y:216, w:86,  h:280, dist:7.2,  area:20287, sev:'warning'}] },
];

let currentVideo = 'jrsam3';
let currentFrame = FRAMES.find(f => f.name === 'jrsam3_11s');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIDEO / FRAME SELECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectVideo(vid) {
  currentVideo = vid;
  document.querySelectorAll('.video-tab').forEach(t =>
    t.classList.toggle('active', t.dataset.vid === vid));

  const isUpload = vid === 'upload';
  const isPlayer = vid === 'player';
  const isKeyframe = !isUpload && !isPlayer;

  document.getElementById('frameStrip').style.display        = isKeyframe ? 'block' : 'none';
  document.getElementById('mainDisplay').style.display       = isKeyframe ? 'grid'  : 'none';
  document.getElementById('infoPanels').style.display        = isKeyframe ? 'grid'  : 'none';
  document.getElementById('uploadZone').style.display        = isUpload   ? 'block' : 'none';
  document.getElementById('videoPlayerSection').style.display = isPlayer  ? 'block' : 'none';

  if (isKeyframe) {
    renderFrameStrip(vid);
    const frames = FRAMES.filter(f => f.video === vid);
    const pick = frames.find(f => f.anoms.length > 0) || frames[0];
    selectFrame(pick.name);
  }
  if (isPlayer) {
    // Auto-load jrsam3 timeline on first open
    if (!playerTimeline) loadTimeline('jrsam3');
  }
}

function renderFrameStrip(vid) {
  const inner = document.getElementById('frameStripInner');
  const frames = FRAMES.filter(f => f.video === vid);
  inner.innerHTML = frames.map(f => `
    <div class="frame-card ${f.name === currentFrame?.name ? 'active' : ''}"
         onclick="selectFrame('${f.name}')" id="fcard-${f.name}">
      <div class="frame-thumb">
        <img src="rail-assets/${f.name}_camera.jpg" alt="${f.ts}s" loading="lazy">
        ${f.anoms.length > 0
          ? `<span class="frame-anom-dot">âš  ${f.anoms.length}</span>`
          : `<span class="frame-ok-dot">âœ“</span>`
        }
      </div>
      <div class="frame-ts">${f.ts}s</div>
    </div>
  `).join('');
}

function selectFrame(name) {
  const frame = FRAMES.find(f => f.name === name);
  if (!frame) return;
  currentFrame = frame;

  // Update frame strip active state
  document.querySelectorAll('.frame-card').forEach(c => c.classList.remove('active'));
  const card = document.getElementById('fcard-' + name);
  if (card) card.classList.add('active');

  // Flash transition
  const flash = document.getElementById('procFlash');
  flash.style.opacity = '1';
  setTimeout(() => { flash.style.opacity = '0'; }, 300);

  // Update images (briefly set to empty to force redraw)
  const cImg = document.getElementById('cameraImg');
  const oImg = document.getElementById('overlayImg');
  cImg.style.opacity = '0.5';
  oImg.style.opacity = '0.5';
  cImg.src = `rail-assets/${name}_camera.jpg`;
  oImg.src = `rail-assets/${name}_overlay.jpg`;
  cImg.onload = () => { cImg.style.opacity = '1'; };
  oImg.onload = () => { oImg.style.opacity = '1'; };

  // Update badge
  document.getElementById('frameLabel').textContent =
    `${frame.video === 'jrsam3' ? 'jrsam3è·¯ç·š' : 'jr23è·¯ç·š'} â€” ${frame.ts}s`;

  // Update panels
  updateMetricPanel(frame);
  updateAlertPanel(frame);

  // Update 3D
  loadDepthForThreeJs(name, frame);
}

function updateMetricPanel(frame) {
  const nearEl = document.getElementById('m-near');
  nearEl.textContent = frame.min.toFixed(2) + ' m';
  nearEl.className = 'metric-val' + (frame.min < 2.5 ? ' danger' : '');

  document.getElementById('m-far').textContent =
    frame.max >= 200 ? '200+ m' : frame.max.toFixed(1) + ' m';

  const clearEl = document.getElementById('m-clearance');
  if (frame.anoms.length > 0) {
    clearEl.textContent = 'è¦ç¢ºèª âš ';
    clearEl.className = 'metric-val danger';
  } else {
    clearEl.textContent = 'å•é¡Œãªã— âœ“';
    clearEl.className = 'metric-val safe';
  }

  const confEl = document.getElementById('m-conf');
  confEl.textContent = (frame.conf * 100).toFixed(1) + '%';
  confEl.className = 'metric-val accent';

  const anomEl = document.getElementById('m-anom');
  anomEl.textContent = frame.anoms.length + ' ä»¶';
  anomEl.className = 'metric-val ' + (frame.anoms.length > 0 ? 'danger' : 'safe');

  document.getElementById('m-time').textContent = frame.ms.toFixed(1) + ' ms';
  document.getElementById('m-model').textContent = 'DA V2 Large-hf';
}

function updateAlertPanel(frame) {
  const list = document.getElementById('alertList');
  if (frame.anoms.length === 0) {
    list.innerHTML = `
      <div class="alert-item ok">
        <span class="alert-badge badge-ok">æ­£å¸¸</span>
        <div class="alert-text">
          <strong>ç•°å¸¸ãªã— â€” ã“ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã¯ã‚¯ãƒªã‚¢</strong>
          <span>æ·±åº¦ç¯„å›²: ${frame.min.toFixed(2)}mâ€“${frame.max >= 200 ? '200m+' : frame.max.toFixed(1) + 'm'} / ä¿¡é ¼åº¦: ${(frame.conf*100).toFixed(1)}%</span>
        </div>
      </div>
      <div class="alert-item ok">
        <span class="alert-badge badge-ok">æ¸ˆ</span>
        <div class="alert-text">
          <strong>å»ºç¯‰é™ç•Œå†… â€” å…¨è¦–é‡æ­£å¸¸</strong>
          <span>å‡¦ç†æ™‚é–“: ${frame.ms.toFixed(1)}ms | RTX 4090 / CUDA</span>
        </div>
      </div>`;
    return;
  }

  list.innerHTML = frame.anoms.map((a, i) => `
    <div class="alert-item ${a.sev}">
      <span class="alert-badge badge-${a.sev === 'critical' ? 'critical' : 'warning'}">${a.sev === 'critical' ? 'ç·Šæ€¥' : 'æ³¨æ„'}</span>
      <div class="alert-text">
        <strong>è¿‘æ¥ç‰©ä½“æ¤œçŸ¥ â€” å‰æ–¹ ${a.dist.toFixed(1)} m</strong>
        <span>
          ä½ç½®: (${a.x}, ${a.y}) / ã‚µã‚¤ã‚º: ${a.w}Ã—${a.h}px / é¢ç©: ${a.area.toLocaleString()} pxÂ²
        </span>
      </div>
    </div>
  `).join('') + `
    <div class="alert-item ok">
      <span class="alert-badge badge-ok">é€ä¿¡æ¸ˆ</span>
      <div class="alert-text">
        <strong>ä¿ç·šæ‹…å½“ã¸ã‚¢ãƒ©ãƒ¼ãƒˆè‡ªå‹•é€šçŸ¥</strong>
        <span>æ¨è«–: ${frame.ms.toFixed(1)}ms | ä¿¡é ¼åº¦: ${(frame.conf*100).toFixed(1)}%</span>
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIDEO PLAYER â€” timeline-based playback
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let playerTimeline   = null;   // loaded timeline.json data
let playerVideoName  = '';
let playerFrameIdx   = 0;
let playerInterval   = null;
let playerSpeed      = 1;      // 0.5, 1, 2
const PLAYER_SPEEDS  = [0.5, 1, 2];
let playerSpeedIdx   = 1;
let sparkChart       = null;
let playerMode       = 'video';

function setPlayerMode(mode) {
  playerMode = mode;
  document.getElementById('pm-video-wrap').style.display  = mode === 'video' ? 'block' : 'none';
  document.getElementById('pm-frame-wrap').style.display  = mode === 'frame' ? 'block' : 'none';
  document.getElementById('pmBtn-video').classList.toggle('active', mode === 'video');
  document.getElementById('pmBtn-frame').classList.toggle('active', mode === 'frame');
  if (mode === 'frame' && playerTimeline) {
    // Pause native video when switching to frame mode
    const vid = document.getElementById('playerVideo');
    if (vid) vid.pause();
    // Redraw sparkline (canvas may need resize)
    setTimeout(() => drawSparkline(playerTimeline), 50);
  }
}

function buildEventsPanel(data) {
  const frames      = data.frames;
  const anomFrames  = frames.filter(f => f.anomaly_count > 0);
  const total       = anomFrames.length;
  const panel       = document.getElementById('eventsPanel');

  const countColor  = total > 0 ? 'var(--danger)' : 'var(--safe)';
  let html = `<div class="events-panel-header">
    <h3>âš  ç•°å¸¸ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</h3>
    <span class="events-count">${frames.length} ãƒ•ãƒ¬ãƒ¼ãƒ ä¸­ <strong style="color:${countColor}">${total}</strong> ä»¶æ¤œçŸ¥</span>
  </div>`;

  if (total === 0) {
    html += `<div style="color:var(--safe);font-size:0.85rem;padding:0.5rem 0">âœ“ ç•°å¸¸ãªã— â€” å…¨åŒºé–“æ­£å¸¸</div>`;
  } else {
    html += anomFrames.map(f => {
      const sev   = f.anomalies[0]?.severity || 'warning';
      const dist  = f.dist_m != null ? `å‰æ–¹ ${f.dist_m} m` : 'è·é›¢ä¸æ˜';
      const score = (f.anomaly_score * 100).toFixed(0);
      const label = sev === 'critical' ? 'ç·Šæ€¥' : 'æ³¨æ„';
      return `<div class="event-row">
        <span class="event-time">${f.ts.toFixed(1)}s</span>
        <div class="event-details">
          <div class="event-title">è¿‘æ¥ç‰©ä½“æ¤œçŸ¥ â€” ${dist}</div>
          <div class="event-meta">ã‚¹ã‚³ã‚¢ ${score}% / ä¿¡é ¼åº¦ ${(f.confidence*100).toFixed(0)}% / ${f.processing_ms.toFixed(0)} ms</div>
        </div>
        <span class="event-badge ${sev}">${label}</span>
      </div>`;
    }).join('');
  }
  panel.innerHTML = html;
}

function printReport() {
  if (!playerTimeline) return;
  const data     = playerTimeline;
  const name     = playerVideoName;
  const today    = new Date().toLocaleDateString('ja-JP', {year:'numeric', month:'2-digit', day:'2-digit'});
  const anomaly  = data.frames.filter(f => f.anomaly_count > 0);
  const avgConf  = (data.frames.reduce((s, f) => s + f.confidence, 0) / data.frames.length * 100).toFixed(1);
  const avgMs    = (data.frames.reduce((s, f) => s + f.processing_ms, 0) / data.frames.length).toFixed(1);

  const eventRows = anomaly.map((f, i) => {
    const a   = f.anomalies[0] || {};
    const sev = a.severity === 'critical' ? 'ç·Šæ€¥' : 'æ³¨æ„';
    return `<tr>
      <td>${i + 1}</td>
      <td>${f.ts.toFixed(1)} s</td>
      <td>${f.dist_m != null ? f.dist_m + ' m' : 'â€”'}</td>
      <td>${(f.anomaly_score * 100).toFixed(0)}%</td>
      <td>${(f.confidence * 100).toFixed(0)}%</td>
      <td><span style="color:${a.severity==='critical'?'#c00':'#a60'};font-weight:700">${sev}</span></td>
      <td>${a.area_px ? a.area_px.toLocaleString() + ' pxÂ²' : 'â€”'}</td>
    </tr>`;
  }).join('');

  const noAnomRow = anomaly.length === 0
    ? `<tr><td colspan="7" style="text-align:center;color:#080;font-weight:700">ç•°å¸¸ãªã— â€” å…¨åŒºé–“æ­£å¸¸</td></tr>` : '';

  const w = window.open('', '_blank');
  w.document.write(`<!DOCTYPE html><html lang="ja"><head>
<meta charset="UTF-8">
<title>RailScan AI ç‚¹æ¤œãƒ¬ãƒãƒ¼ãƒˆ â€” ${name}</title>
<style>
  body { font-family: 'Hiragino Sans', 'Noto Sans JP', sans-serif; margin: 0; padding: 2cm; color: #111; font-size: 11pt; }
  h1 { font-size: 18pt; margin-bottom: 4px; }
  .subtitle { color: #555; font-size: 10pt; margin-bottom: 1.5rem; }
  .header-bar { display:flex; justify-content:space-between; align-items:flex-start; border-bottom: 2px solid #f59e0b; padding-bottom: 0.75rem; margin-bottom: 1.5rem; }
  .logo { font-size: 13pt; font-weight: 800; }
  .logo span { color: #f59e0b; }
  .badge { background:#f59e0b; color:#000; font-size:8pt; font-weight:800; padding:2px 7px; border-radius:4px; }
  .meta-grid { display:grid; grid-template-columns:1fr 1fr; gap:0.5rem 2rem; margin-bottom:1.5rem; font-size:10pt; }
  .meta-row { display:flex; justify-content:space-between; border-bottom:1px solid #e5e5e5; padding:4px 0; }
  .meta-key { color:#555; }
  .meta-val { font-weight:700; }
  h2 { font-size:13pt; border-left:3px solid #f59e0b; padding-left:0.5rem; margin:1.5rem 0 0.75rem; }
  table { width:100%; border-collapse:collapse; font-size:10pt; }
  th { background:#f5f5f5; text-align:left; padding:6px 8px; border:1px solid #ddd; font-size:9pt; }
  td { padding:6px 8px; border:1px solid #ddd; }
  tr:nth-child(even) { background:#fafafa; }
  .summary-box { background:#fff8e6; border:1px solid #f59e0b; border-radius:6px; padding:0.75rem 1rem; margin-bottom:1.5rem; }
  .summary-ok  { background:#f0fff4; border-color:#22c55e; }
  .footer { margin-top:2rem; font-size:9pt; color:#888; text-align:center; border-top:1px solid #ddd; padding-top:0.75rem; }
  @media print { body { padding: 1cm 1.5cm; } button { display:none !important; } }
</style></head><body>
<div class="header-bar">
  <div>
    <div class="logo">Spatial<span>Forge</span> <span class="badge">RAIL</span></div>
    <h1>AIè»Œé“ç‚¹æ¤œãƒ¬ãƒãƒ¼ãƒˆ</h1>
    <div class="subtitle">RailScan AI â€” Depth Anything V2 Large by SpatialForge</div>
  </div>
  <div style="text-align:right;font-size:9pt;color:#555">
    <div>å‡ºåŠ›æ—¥æ™‚: ${today}</div>
    <div>å¯¾è±¡è·¯ç·š: ${name}</div>
  </div>
</div>

<div class="meta-grid">
  <div>
    <div class="meta-row"><span class="meta-key">å¯¾è±¡è·¯ç·š</span><span class="meta-val">${name}</span></div>
    <div class="meta-row"><span class="meta-key">è§£æãƒ•ãƒ¬ãƒ¼ãƒ æ•°</span><span class="meta-val">${data.total_frames} ãƒ•ãƒ¬ãƒ¼ãƒ </span></div>
    <div class="meta-row"><span class="meta-key">å‹•ç”»æ™‚é–“</span><span class="meta-val">${data.duration_s.toFixed(1)} ç§’</span></div>
    <div class="meta-row"><span class="meta-key">å‡¦ç†ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ</span><span class="meta-val">${data.fps_processed} fps</span></div>
  </div>
  <div>
    <div class="meta-row"><span class="meta-key">ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«</span><span class="meta-val">Depth Anything V2 Large</span></div>
    <div class="meta-row"><span class="meta-key">æ¨è«–ãƒ‡ãƒã‚¤ã‚¹</span><span class="meta-val">RTX 4090 (CUDA)</span></div>
    <div class="meta-row"><span class="meta-key">å¹³å‡æ¨è«–æ™‚é–“</span><span class="meta-val">${avgMs} ms/ãƒ•ãƒ¬ãƒ¼ãƒ </span></div>
    <div class="meta-row"><span class="meta-key">å¹³å‡ä¿¡é ¼åº¦</span><span class="meta-val">${avgConf}%</span></div>
  </div>
</div>

<div class="summary-box ${anomaly.length === 0 ? 'summary-ok' : ''}">
  ${anomaly.length === 0
    ? '<strong style="color:#166534">âœ“ ç•°å¸¸ãªã—</strong> â€” è§£æåŒºé–“å…¨ä½“ã§è»Œé“ç•°å¸¸ã¯æ¤œçŸ¥ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚'
    : `<strong style="color:#92400e">âš  ${anomaly.length} ä»¶ã®ç•°å¸¸ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œçŸ¥</strong> â€” ä¸‹è¡¨ã®å„ãƒ•ãƒ¬ãƒ¼ãƒ ã§è»Œé“å‰æ–¹ã¸ã®è¿‘æ¥ç‰©ä½“ãŒç¢ºèªã•ã‚Œã¾ã—ãŸã€‚é€Ÿã‚„ã‹ã«ä¿ç·šæ‹…å½“è€…ã¸ã”ç¢ºèªãã ã•ã„ã€‚`}
</div>

<h2>ç•°å¸¸æ¤œçŸ¥ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</h2>
<table>
  <thead>
    <tr><th>#</th><th>ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</th><th>æ¨å®šè·é›¢</th><th>ç•°å¸¸ã‚¹ã‚³ã‚¢</th><th>ä¿¡é ¼åº¦</th><th>é‡ç—‡åº¦</th><th>ãƒ–ãƒ­ãƒ–é¢ç©</th></tr>
  </thead>
  <tbody>${eventRows}${noAnomRow}</tbody>
</table>

<div class="footer">
  æœ¬ãƒ¬ãƒãƒ¼ãƒˆã¯ SpatialForge RailScan AI ãŒè‡ªå‹•ç”Ÿæˆã—ãŸæš«å®šãƒ¬ãƒãƒ¼ãƒˆã§ã™ã€‚æœ€çµ‚åˆ¤æ–­ã¯ä¿ç·šæ‹…å½“è€…ãŒç¾åœ°ç¢ºèªã®ä¸Šã§è¡Œã£ã¦ãã ã•ã„ã€‚<br>
  SpatialForge â€” spatialforge-demo.fly.dev â€” ${today}
</div>
<br>
<button onclick="window.print()" style="padding:8px 20px;background:#f59e0b;border:none;border-radius:6px;font-weight:700;cursor:pointer;font-size:11pt">ğŸ–¨ å°åˆ· / PDFä¿å­˜</button>
</body></html>`);
  w.document.close();
}

async function loadTimeline(name, tabEl) {
  // Update sub-tabs
  document.querySelectorAll('.pvtab').forEach(t => t.classList.toggle('active', t === tabEl));

  // Stop any running playback
  if (playerInterval) { clearInterval(playerInterval); playerInterval = null; }
  document.getElementById('playBtn').textContent = 'â–¶';

  // Show loading
  document.getElementById('playerLoading').style.display = 'flex';
  document.getElementById('playerReady').style.display   = 'none';

  playerVideoName = name;
  const url = `rail-assets/video/${name}/timeline.json`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    playerTimeline = data;

    // Wire up native video element
    const vid    = document.getElementById('playerVideo');
    const mp4Src = `rail-assets/video/${name}/${name}_analysis.mp4`;
    vid.src = mp4Src;
    vid.load();

    // Show download button
    const dlBtn      = document.getElementById('mp4DownloadBtn');
    dlBtn.href        = mp4Src;
    dlBtn.download    = `${name}_analysis.mp4`;
    dlBtn.style.display = 'flex';

    // Build events panel
    buildEventsPanel(data);

    // Initialize scrubber
    const scrubber = document.getElementById('playerScrubber');
    scrubber.max   = data.total_frames - 1;
    scrubber.value = 0;

    // Draw sparkline
    drawSparkline(data);

    // Start in video mode
    setPlayerMode('video');

    // Show player
    document.getElementById('playerLoading').style.display = 'none';
    document.getElementById('playerReady').style.display   = 'block';
    displayPlayerFrame(0);

  } catch(e) {
    document.getElementById('playerLoading').innerHTML =
      `<div style="color:var(--muted);text-align:center">
        <div style="font-size:1.5rem;margin-bottom:0.5rem">â³</div>
        <strong style="color:var(--accent)">å‹•ç”»å‡¦ç†ä¸­...</strong><br>
        <span style="font-size:0.82rem">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚æ•°åˆ†å¾Œã«ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</span>
       </div>`;
    document.getElementById('playerLoading').style.display = 'flex';
  }
}

function displayPlayerFrame(idx) {
  if (!playerTimeline) return;
  const frames = playerTimeline.frames;
  if (idx < 0 || idx >= frames.length) return;

  playerFrameIdx = idx;
  const f = frames[idx];

  // Update image
  const img = document.getElementById('playerImg');
  img.src = `rail-assets/video/${playerVideoName}/${f.files.overlay}`;

  // Update scrubber
  document.getElementById('playerScrubber').value = idx;

  // Update HUD
  document.getElementById('playerTs').textContent = f.ts.toFixed(1) + 's';
  const anomHud = document.getElementById('playerAnomHud');
  if (f.anomaly_count > 0) {
    anomHud.style.display = 'inline-block';
    anomHud.textContent   = `âš  ${f.dist_m}m`;
    // Flash
    const flash = document.getElementById('playerAnomFlash');
    flash.style.opacity = '1';
    setTimeout(() => { flash.style.opacity = '0'; }, 200);
  } else {
    anomHud.style.display = 'none';
  }

  // Update time display
  document.getElementById('playerTimeDisplay').textContent =
    `${f.ts.toFixed(1)}s / ${playerTimeline.duration_s.toFixed(1)}s`;

  // Update metrics
  document.getElementById('pm-ts').textContent   = f.ts.toFixed(2) + ' s';
  document.getElementById('pm-near').textContent = f.near_m.toFixed(2) + ' m';
  document.getElementById('pm-near').className   = 'metric-val' + (f.near_m < 2.5 ? ' danger' : '');
  document.getElementById('pm-far').textContent  = (f.far_m >= 200 ? '200+ m' : f.far_m.toFixed(1) + ' m');
  document.getElementById('pm-score').textContent = f.anomaly_score > 0
    ? (f.anomaly_score * 100).toFixed(1) + '%'
    : 'â€”';
  document.getElementById('pm-score').className = 'metric-val ' + (f.anomaly_score > 0.5 ? 'danger' : f.anomaly_score > 0 ? 'accent' : 'safe');
  document.getElementById('pm-conf').textContent = (f.confidence * 100).toFixed(1) + '%';
  document.getElementById('pm-conf').className   = 'metric-val accent';
  document.getElementById('pm-ms').textContent   = f.processing_ms.toFixed(1) + ' ms';

  // Update alert list
  updatePlayerAlerts(f);

  // Update sparkline cursor
  drawSparklineCursor(idx);
}

function updatePlayerAlerts(f) {
  const list = document.getElementById('playerAlertList');
  if (f.anomaly_count === 0) {
    list.innerHTML = `
      <div class="alert-item ok">
        <span class="alert-badge badge-ok">æ­£å¸¸</span>
        <div class="alert-text">
          <strong>ç•°å¸¸ãªã— â€” t=${f.ts.toFixed(1)}s</strong>
          <span>æ·±åº¦ ${f.near_m.toFixed(1)}mâ€“${f.far_m >= 200 ? '200m+' : f.far_m.toFixed(0) + 'm'} / ä¿¡é ¼åº¦ ${(f.confidence*100).toFixed(1)}%</span>
        </div>
      </div>`;
    return;
  }
  list.innerHTML = f.anomalies.map(a => `
    <div class="alert-item ${a.severity}">
      <span class="alert-badge badge-${a.severity === 'critical' ? 'critical' : 'warning'}">${a.severity === 'critical' ? 'ç·Šæ€¥' : 'æ³¨æ„'}</span>
      <div class="alert-text">
        <strong>è¿‘æ¥ç‰©ä½“æ¤œçŸ¥ â€” å‰æ–¹ ${a.dist_m} m  (t=${f.ts.toFixed(1)}s)</strong>
        <span>æ·±åº¦ mean=${a.depth_mean.toFixed(3)} / é¢ç© ${a.area_px.toLocaleString()} pxÂ²</span>
      </div>
    </div>`).join('');
}

function togglePlay() {
  if (playerInterval) {
    clearInterval(playerInterval);
    playerInterval = null;
    document.getElementById('playBtn').textContent = 'â–¶';
  } else {
    document.getElementById('playBtn').textContent = 'â¸';
    const fps = playerTimeline ? playerTimeline.fps_processed : 3;
    const intervalMs = Math.round(1000 / (fps * playerSpeed));
    playerInterval = setInterval(() => {
      if (!playerTimeline) return;
      const next = playerFrameIdx + 1;
      if (next >= playerTimeline.total_frames) {
        // Loop
        displayPlayerFrame(0);
      } else {
        displayPlayerFrame(next);
      }
    }, intervalMs);
  }
}

function scrubTo(idx) {
  if (playerInterval) { clearInterval(playerInterval); playerInterval = null; document.getElementById('playBtn').textContent = 'â–¶'; }
  displayPlayerFrame(idx);
}

function cycleSpeed() {
  playerSpeedIdx = (playerSpeedIdx + 1) % PLAYER_SPEEDS.length;
  playerSpeed    = PLAYER_SPEEDS[playerSpeedIdx];
  document.getElementById('speedBtn').textContent = playerSpeed + 'Ã—';
  if (playerInterval) { clearInterval(playerInterval); playerInterval = null; togglePlay(); }
}

// â”€â”€ Sparkline (custom canvas) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawSparkline(data) {
  const canvas = document.getElementById('sparkCanvas');
  const W = canvas.offsetWidth || canvas.parentElement.clientWidth || 800;
  canvas.width  = W * window.devicePixelRatio;
  canvas.height = 64 * window.devicePixelRatio;
  canvas.style.height = '64px';
  const ctx = canvas.getContext('2d');
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

  const H     = 64;
  const PAD   = 4;
  const n     = data.frames.length;

  // Background
  ctx.fillStyle = 'transparent';
  ctx.clearRect(0, 0, W, H);

  // Grid lines
  ctx.strokeStyle = '#1e1e2e';
  ctx.lineWidth   = 1;
  [0.25, 0.5, 0.75].forEach(frac => {
    const y = PAD + (H - PAD*2) * (1 - frac);
    ctx.beginPath(); ctx.moveTo(PAD, y); ctx.lineTo(W-PAD, y); ctx.stroke();
  });

  if (n === 0) return;

  // Anomaly highlight regions
  data.frames.forEach((f, i) => {
    if (f.anomaly_count === 0) return;
    const x0 = PAD + (i     / n) * (W - PAD*2);
    const x1 = PAD + ((i+1) / n) * (W - PAD*2);
    ctx.fillStyle = 'rgba(239,68,68,0.12)';
    ctx.fillRect(x0, PAD, x1-x0, H-PAD*2);
  });

  // Score line
  ctx.beginPath();
  ctx.strokeStyle = '#f59e0b';
  ctx.lineWidth   = 2;
  data.frames.forEach((f, i) => {
    const x = PAD + (i / (n-1)) * (W - PAD*2);
    const y = PAD + (H - PAD*2) * (1 - f.anomaly_score);
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Anomaly dots
  data.frames.forEach((f, i) => {
    if (f.anomaly_count === 0) return;
    const x = PAD + (i / (n-1)) * (W - PAD*2);
    const y = PAD + (H - PAD*2) * (1 - f.anomaly_score);
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, Math.PI*2);
    ctx.fillStyle = '#ef4444';
    ctx.fill();
  });

  // Store reference for cursor
  canvas._sparkData = data;

  // Click to jump
  canvas.onclick = (e) => {
    const rect = canvas.getBoundingClientRect();
    const rx   = (e.clientX - rect.left) / rect.width;
    const idx  = Math.round(rx * (data.total_frames - 1));
    scrubTo(idx);
  };
}

function drawSparklineCursor(idx) {
  const canvas = document.getElementById('sparkCanvas');
  const data   = canvas._sparkData;
  if (!data) return;

  const W = canvas.width  / window.devicePixelRatio;
  const H = canvas.height / window.devicePixelRatio;
  const PAD = 4;
  const n   = data.frames.length;

  // Redraw base (cheap: just draw the cursor line on top of existing)
  // We need to redraw the whole sparkline for clean cursor
  const ctx = canvas.getContext('2d');
  ctx.save();
  ctx.setTransform(1,0,0,1,0,0);
  ctx.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0);

  // Re-draw base sparkline
  drawSparkline(data);

  // Cursor
  const x = PAD + (idx / (n-1)) * (W - PAD*2);
  ctx.strokeStyle = 'rgba(255,255,255,0.6)';
  ctx.lineWidth   = 1.5;
  ctx.setLineDash([3,3]);
  ctx.beginPath(); ctx.moveTo(x, PAD); ctx.lineTo(x, H-PAD); ctx.stroke();
  ctx.setLineDash([]);

  // Current dot
  const f = data.frames[idx];
  const y = PAD + (H - PAD*2) * (1 - f.anomaly_score);
  ctx.beginPath(); ctx.arc(x, y, 5, 0, Math.PI*2);
  ctx.fillStyle = f.anomaly_count > 0 ? '#ef4444' : '#f59e0b';
  ctx.fill();

  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPLOAD HANDLER (real API call with fallback)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleUpload(file) {
  if (!file) return;
  document.getElementById('uploadZone').style.display = 'none';
  document.getElementById('mainDisplay').style.display = 'grid';
  document.getElementById('infoPanels').style.display = 'grid';

  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      document.getElementById('cameraImg').src = e.target.result;
      document.getElementById('cameraImg').style.opacity = '1';
      callDepthAPI(file).catch(() => {
        // Fallback: show placeholder
        document.getElementById('overlayImg').src = 'rail-assets/jrsam3_11s_overlay.jpg';
        document.getElementById('overlayImg').style.opacity = '1';
        updateAlertPanel({ anoms:[], min:0, max:0, conf:0, ms:0 });
      });
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

async function callDepthAPI(file) {
  const API = 'https://spatialforge-demo.fly.dev';
  const form = new FormData();
  form.append('image', file);
  const res = await fetch(`${API}/v1/depth/visualize`, { method:'POST', body:form });
  if (!res.ok) throw new Error('API error');
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const oImg = document.getElementById('overlayImg');
  oImg.src = url;
  oImg.style.opacity = '1';
  const minD  = res.headers.get('X-Depth-Min') || 'â€”';
  const maxD  = res.headers.get('X-Depth-Max') || 'â€”';
  const procMs = res.headers.get('X-Processing-Ms') || 'â€”';
  const model  = res.headers.get('X-Model') || 'DA V2 Large-hf';
  document.getElementById('m-near').textContent = parseFloat(minD).toFixed(2) + ' m';
  document.getElementById('m-far').textContent  = parseFloat(maxD).toFixed(0)  + ' m';
  document.getElementById('m-time').textContent = procMs + ' ms';
  document.getElementById('m-model').textContent = model;
  document.getElementById('m-conf').textContent = 'â€”';
  document.getElementById('m-clearance').textContent = 'æ‰‹å‹•ç¢ºèª';
  document.getElementById('m-anom').textContent = 'â€”';
  document.getElementById('alertList').innerHTML =
    '<div class="alert-item ok"><span class="alert-badge badge-ok">å®Œäº†</span><div class="alert-text"><strong>æ·±åº¦è§£æå®Œäº†</strong><span>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒã‚’è§£æã—ã¾ã—ãŸ</span></div></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TURBO COLORMAP (for 3D visualization)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TURBO_STOPS = [
  [0.00,[48,18,59]],[0.10,[63,85,183]],[0.20,[50,146,207]],
  [0.30,[26,186,164]],[0.40,[74,210,98]],[0.50,[174,221,49]],
  [0.60,[234,185,35]],[0.70,[245,129,21]],[0.80,[234,66,18]],
  [0.90,[196,27,27]],[1.00,[122,4,3]],
];

function turboColor(t) {
  t = Math.max(0, Math.min(1, t));
  for (let i = 1; i < TURBO_STOPS.length; i++) {
    if (t <= TURBO_STOPS[i][0]) {
      const a = (t - TURBO_STOPS[i-1][0]) / (TURBO_STOPS[i][0] - TURBO_STOPS[i-1][0]);
      const c0 = TURBO_STOPS[i-1][1], c1 = TURBO_STOPS[i][1];
      return [Math.round(c0[0]+a*(c1[0]-c0[0])), Math.round(c0[1]+a*(c1[1]-c0[1])), Math.round(c0[2]+a*(c1[2]-c0[2]))];
    }
  }
  return [122,4,3];
}

// Convert turbo-colored pixel â†’ approximate depth (0=far, 1=near)
// Uses hue mapping: Turbo goes purple(~280Â°)=far â†’ red(~0Â°)=near
function turboPixelToDepth(r, g, b) {
  const rf = r/255, gf = g/255, bf = b/255;
  const cmax = Math.max(rf,gf,bf), cmin = Math.min(rf,gf,bf), d = cmax-cmin;
  if (cmax < 0.12) return 0.02; // very dark = very far
  if (d < 0.04) return 0.45;   // near-gray = mid-range
  let h;
  if (cmax===rf) h = 60 * (((gf-bf)/d % 6 + 6) % 6);
  else if (cmax===gf) h = 60 * ((bf-rf)/d + 2);
  else h = 60 * ((rf-gf)/d + 4);
  // Purple 280Â°=far(0) â†’ Green 120Â°=mid(0.4) â†’ Red 0Â°=near(1)
  if (h > 270) return Math.max(0, (310 - h) / 310 * 0.15);
  return Math.max(0, Math.min(1, (280 - h) / 280));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THREE.JS 3D VISUALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let threeRenderer, threeScene, threeCamera, threePoints, threeMesh;
let autoRotate = false;
let vizMode = 'point';
let isDragging = false, prevMouse = {x:0,y:0};
let spherical = {theta: 0.4, phi: 0.7, r: 5.5};
let currentDepthPixels = null, depthPxW = 0, depthPxH = 0;

function initThreeJs() {
  const canvas = document.getElementById('threeCanvas');
  threeRenderer = new THREE.WebGLRenderer({canvas, antialias:true});
  threeRenderer.setPixelRatio(window.devicePixelRatio);
  threeRenderer.setSize(canvas.clientWidth, canvas.clientHeight);
  threeRenderer.setClearColor(0x0a0a0f, 1);

  threeScene = new THREE.Scene();
  threeCamera = new THREE.PerspectiveCamera(60, canvas.clientWidth/canvas.clientHeight, 0.01, 100);
  updateThreeCamera();

  threeScene.add(new THREE.AmbientLight(0xffffff, 0.6));
  const dir = new THREE.DirectionalLight(0xffffff, 0.8);
  dir.position.set(2,4,3); threeScene.add(dir);

  const grid = new THREE.GridHelper(8, 20, 0x1e1e2e, 0x1e1e2e);
  grid.position.y = -1.5; threeScene.add(grid);

  // Mouse orbit
  canvas.addEventListener('mousedown', e => { isDragging=true; prevMouse={x:e.clientX,y:e.clientY}; });
  canvas.addEventListener('mouseup',   () => { isDragging=false; });
  canvas.addEventListener('mousemove', e => {
    if (!isDragging) return;
    spherical.theta -= (e.clientX-prevMouse.x)*0.008;
    spherical.phi = Math.max(0.1, Math.min(1.4, spherical.phi + (e.clientY-prevMouse.y)*0.008));
    prevMouse = {x:e.clientX,y:e.clientY};
    updateThreeCamera();
  });
  canvas.addEventListener('wheel', e => {
    e.preventDefault();
    spherical.r = Math.max(2, Math.min(12, spherical.r + e.deltaY*0.008));
    updateThreeCamera();
  }, {passive:false});
  let lt = null;
  canvas.addEventListener('touchstart', e => { lt=e.touches[0]; });
  canvas.addEventListener('touchmove', e => {
    e.preventDefault(); if(!lt) return;
    spherical.theta -= (e.touches[0].clientX-lt.clientX)*0.01;
    spherical.phi = Math.max(0.1, Math.min(1.4, spherical.phi+(e.touches[0].clientY-lt.clientY)*0.01));
    lt=e.touches[0]; updateThreeCamera();
  }, {passive:false});

  animate();
  // Load depth from default frame
  loadDepthForThreeJs('jrsam3_11s', currentFrame);
}

function updateThreeCamera() {
  const {theta,phi,r} = spherical;
  threeCamera.position.set(r*Math.sin(phi)*Math.sin(theta), r*Math.cos(phi), r*Math.sin(phi)*Math.cos(theta));
  threeCamera.lookAt(0,0,0);
}

function loadDepthForThreeJs(name, frame) {
  const img = new Image();
  img.onload = function() {
    const W=96, H=54; // 16:9 grid
    const off = document.createElement('canvas');
    off.width=W; off.height=H;
    const ctx = off.getContext('2d');
    ctx.drawImage(img, 0, 0, W, H);
    try {
      const px = ctx.getImageData(0,0,W,H).data;
      currentDepthPixels = px; depthPxW=W; depthPxH=H;
      buildThreeJsFromPixels(W, H);
    } catch(e) {
      // CORS / local file fallback
      buildThreeJsSynthetic(frame);
    }
  };
  img.onerror = () => buildThreeJsSynthetic(frame);
  img.src = `rail-assets/${name}_depth.jpg`;
}

function buildThreeJsFromPixels(GW, GH) {
  if (!threeScene) return;
  if (threePoints) { threeScene.remove(threePoints); threePoints.geometry.dispose(); }
  if (threeMesh)   { threeScene.remove(threeMesh);   threeMesh.geometry.dispose();   }

  const positions=[], colors=[], meshVerts=[], meshColors=[], meshIdx=[];

  for (let j=0; j<GH; j++) {
    for (let i=0; i<GW; i++) {
      const idx=(j*GW+i)*4;
      const r=currentDepthPixels[idx], g=currentDepthPixels[idx+1], b=currentDepthPixels[idx+2];
      const d = turboPixelToDepth(r,g,b);
      const u=i/(GW-1), v=j/(GH-1);
      const ps=0.5+d*1.5;
      const wx=(u-0.5)*4*ps, wy=(d-0.5)*-1.2, wz=(1-d)*5-2.5;
      positions.push(wx,wy,wz); colors.push(r/255,g/255,b/255);
      meshVerts.push(wx,wy,wz); meshColors.push(r/255,g/255,b/255);
      if (i<GW-1 && j<GH-1) {
        const tl=j*GW+i, tr=tl+1, bl=tl+GW, br=bl+1;
        meshIdx.push(tl,bl,tr, tr,bl,br);
      }
    }
  }
  _buildGeometry(positions, colors, meshVerts, meshColors, meshIdx);
}

// Synthetic depth for local testing fallback, uses real anomaly position
function seededNoise(x,y,s) { const n=Math.sin(x*127.1+y*311.7+s*74.3)*43758.5453; return n-Math.floor(n); }

function buildThreeJsSynthetic(frame) {
  if (!threeScene) return;
  if (threePoints) { threeScene.remove(threePoints); threePoints.geometry.dispose(); }
  if (threeMesh)   { threeScene.remove(threeMesh);   threeMesh.geometry.dispose();   }

  const GW=96, GH=72;
  // Get hotspot from real anomaly coords (in 960x540 image space)
  const hs = frame && frame.anoms.length > 0 ? {
    u0: frame.anoms[0].x / 960,
    v0: frame.anoms[0].y / 540,
    u1: (frame.anoms[0].x + frame.anoms[0].w) / 960,
    v1: (frame.anoms[0].y + frame.anoms[0].h) / 540,
    d: 0.78
  } : null;

  const positions=[], colors=[], meshVerts=[], meshColors=[], meshIdx=[];
  for (let j=0; j<GH; j++) {
    for (let i=0; i<GW; i++) {
      const u=i/(GW-1), v=j/(GH-1);
      let d = synthDepth(u,v,hs);
      const [r,g,b]=turboColor(d);
      const ps=0.5+d*1.5;
      const wx=(u-0.5)*4*ps, wy=(d-0.5)*-1.2, wz=(1-d)*5-2.5;
      positions.push(wx,wy,wz); colors.push(r/255,g/255,b/255);
      meshVerts.push(wx,wy,wz); meshColors.push(r/255,g/255,b/255);
      if (i<GW-1 && j<GH-1) {
        const tl=j*GW+i, tr=tl+1, bl=tl+GW, br=bl+1;
        meshIdx.push(tl,bl,tr, tr,bl,br);
      }
    }
  }
  _buildGeometry(positions, colors, meshVerts, meshColors, meshIdx);
}

function synthDepth(u, v, hs) {
  if (v < 0.32) return 0.03 + seededNoise(u*40,v*40,1)*0.03;
  const gt=(v-0.32)/0.68;
  let d=0.04+gt*0.91;
  const tc=0.5, thw=0.11+gt*0.07;
  const lr=tc-0.068*(1+gt*0.4), rr=tc+0.068*(1+gt*0.4), rw=0.008+gt*0.005;
  if (Math.abs(u-lr)<rw || Math.abs(u-rr)<rw) d+=0.025;
  if (Math.sin((gt*22)*Math.PI)>0.55 && Math.abs(u-tc)<thw*1.3) d+=0.015;
  if (Math.abs(u-tc)>thw && Math.abs(u-tc)<thw*2.5) d-=0.04;
  if (Math.abs(u-tc)>thw*2.5) d-=0.06;
  if (hs && u>=hs.u0 && u<=hs.u1 && v>=hs.v0 && v<=hs.v1) {
    const hx=(u-hs.u0)/(hs.u1-hs.u0), hy=(v-hs.v0)/(hs.v1-hs.v0);
    const ef=Math.min(hx,1-hx,hy,1-hy)*4;
    const tgt=hs.d+seededNoise(u*20,v*20,3)*0.04;
    d=d+Math.min(1,ef)*(tgt-d);
  }
  d+=(seededNoise(u*80,v*80,7)-0.5)*0.018;
  return Math.max(0,Math.min(1,d));
}

function _buildGeometry(pos, col, mv, mc, mi) {
  const ptGeo = new THREE.BufferGeometry();
  ptGeo.setAttribute('position', new THREE.Float32BufferAttribute(pos,3));
  ptGeo.setAttribute('color',    new THREE.Float32BufferAttribute(col,3));
  const ptMat = new THREE.PointsMaterial({size:0.045, vertexColors:true, sizeAttenuation:true});
  threePoints = new THREE.Points(ptGeo, ptMat);
  threePoints.visible = vizMode==='point';
  threeScene.add(threePoints);

  const mGeo = new THREE.BufferGeometry();
  mGeo.setAttribute('position', new THREE.Float32BufferAttribute(mv,3));
  mGeo.setAttribute('color',    new THREE.Float32BufferAttribute(mc,3));
  mGeo.setIndex(mi); mGeo.computeVertexNormals();
  const mMat = new THREE.MeshPhongMaterial({vertexColors:true, side:THREE.DoubleSide, shininess:8});
  threeMesh = new THREE.Mesh(mGeo, mMat);
  threeMesh.visible = vizMode==='mesh';
  threeScene.add(threeMesh);
}

function setVizMode(mode, e) {
  vizMode = mode;
  document.querySelectorAll('.viz-btn').forEach(b => b.classList.remove('active'));
  if (e && e.target) e.target.classList.add('active');
  if (threePoints) threePoints.visible = mode==='point';
  if (threeMesh)   threeMesh.visible   = mode==='mesh';
}

function resetCamera() {
  spherical = {theta:0.4, phi:0.7, r:5.5};
  updateThreeCamera();
}

function toggleAutoRotate(e) {
  autoRotate = !autoRotate;
  if (e && e.target) e.target.classList.toggle('active', autoRotate);
}

function animate() {
  requestAnimationFrame(animate);
  if (autoRotate) { spherical.theta += 0.004; updateThreeCamera(); }
  const canvas = document.getElementById('threeCanvas');
  if (canvas.clientWidth !== threeRenderer.domElement.width ||
      canvas.clientHeight !== threeRenderer.domElement.height) {
    threeRenderer.setSize(canvas.clientWidth, canvas.clientHeight);
    threeCamera.aspect = canvas.clientWidth/canvas.clientHeight;
    threeCamera.updateProjectionMatrix();
  }
  threeRenderer.render(threeScene, threeCamera);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART.JS DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initDashboard() {
  const days=[], data=[];
  const today=new Date();
  for (let i=29;i>=0;i--) {
    const d=new Date(today); d.setDate(d.getDate()-i);
    days.push(`${d.getMonth()+1}/${d.getDate()}`);
    const base=2.0+Math.sin(i*0.35)*1.2;
    data.push(Math.max(0,Math.round(base+(seededNoise(i*0.1,0,42)-0.5)*2)));
  }
  // å®Ÿæ¸¬: ä»Šæ—¥9ä»¶, 1é€±å‰5ä»¶
  data[data.length-1]=9; data[data.length-7]=5; data[data.length-14]=7;

  new Chart(document.getElementById('trendChart'),{
    type:'line',
    data:{labels:days, datasets:[{label:'ç•°å¸¸æ¤œçŸ¥ä»¶æ•°',data, fill:true,
      backgroundColor:'rgba(245,158,11,0.1)', borderColor:'#f59e0b', borderWidth:2,
      pointRadius:3, pointBackgroundColor:'#f59e0b', tension:0.3}]},
    options:{responsive:true, maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:'#8888a0',font:{size:10},maxTicksLimit:10},grid:{color:'#1e1e2e'}},
        y:{ticks:{color:'#8888a0',font:{size:10}},grid:{color:'#1e1e2e'},min:0,suggestedMax:12}}}
  });

  new Chart(document.getElementById('typeChart'),{
    type:'doughnut',
    data:{
      labels:['è¿‘æ¥ç‰©ä½“','å»ºç¯‰é™ç•Œæ”¯éšœ','è»Œé“å¤‰å½¢','ãƒãƒ©ã‚¹ãƒˆç•°çŠ¶','ãã®ä»–'],
      datasets:[{data:[42,24,18,10,6],
        backgroundColor:['#f59e0b','#ef4444','#fb923c','#6366f1','#8888a0'], borderWidth:0}]},
    options:{responsive:true, maintainAspectRatio:false,
      plugins:{legend:{position:'bottom',labels:{color:'#8888a0',font:{size:11},padding:10,boxWidth:12}}},
      cutout:'65%'}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HERO COUNTER ANIMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function animateCounter(el, target, suffix, duration) {
  let start=null;
  const isDecimal=String(target).includes('.');
  function step(ts) {
    if (!start) start=ts;
    const prog=Math.min((ts-start)/duration,1);
    const ease=1-Math.pow(1-prog,3);
    el.textContent=(isDecimal?(target*ease).toFixed(1):Math.round(target*ease))+suffix;
    if (prog<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  // Render initial frame strip and select default anomaly frame
  renderFrameStrip('jrsam3');
  selectFrame('jrsam3_11s');

  // Three.js (deferred)
  setTimeout(initThreeJs, 400);

  // Dashboard
  initDashboard();

  // Hero counters
  const obs = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        animateCounter(document.getElementById('stat1'), 1847, '', 1800);
        animateCounter(document.getElementById('stat2'), 40,   '', 1600);
        animateCounter(document.getElementById('stat3'), 30,   'x', 1600);
        animateCounter(document.getElementById('stat4'), 47,   '', 1900);
        obs.disconnect();
      }
    });
  }, {threshold:0.3});
  obs.observe(document.querySelector('.hero-stats'));

  // Drag and drop
  const dz = document.getElementById('dropZone');
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag-over'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
  dz.addEventListener('drop', e => {
    e.preventDefault(); dz.classList.remove('drag-over');
    handleUpload(e.dataTransfer.files[0]);
  });

  // Resize
  window.addEventListener('resize', () => {
    if (!threeRenderer) return;
    const c = document.getElementById('threeCanvas');
    threeRenderer.setSize(c.clientWidth, c.clientHeight);
    threeCamera.aspect = c.clientWidth/c.clientHeight;
    threeCamera.updateProjectionMatrix();
  });

  // Live dashboard counter
  setInterval(() => {
    const el = document.getElementById('dash-runs');
    if (el) el.textContent = parseInt(el.textContent)+1;
  }, 8000);
});
</script>
</body>
</html>
