<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RailScan â€” AIè»Œé“ç‚¹æ¤œãƒ‡ãƒ¢</title>
  <meta name="description" content="ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦AIã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è»Œé“æ¬ é™¥æ¤œçŸ¥ãƒ»å»ºç¯‰é™ç•Œãƒã‚§ãƒƒã‚¯ã‚’ä½“é¨“ã€‚">
  <meta property="og:title" content="RailScan AIè»Œé“ç‚¹æ¤œãƒ‡ãƒ¢">
  <meta property="og:description" content="AIãŒå³åº§ã«è»Œé“æ¬ é™¥ã‚’æ¤œçŸ¥ãƒ»åˆ†é¡ã€‚å»ºç¯‰é™ç•Œä¾µå…¥ã‚‚è‡ªå‹•æ¤œå‡ºã€‚">
  <meta property="og:url" content="https://maruyamakoju.github.io/spatialforge/inspect.html">
  <style>
    /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --amber:  #f59e0b;
      --amber2: #d97706;
      --amber3: #fbbf24;
      --dark:   #0a0a0f;
      --dark2:  #111118;
      --dark3:  #1a1a2e;
      --surface: #16213e;
      --surface2: #1e2a45;
      --text:   #e2e8f0;
      --muted:  #94a3b8;
      --border: rgba(245,158,11,0.2);
      --critical: #ef4444;
      --major:    #f97316;
      --minor:    #eab308;
      --info:     #3b82f6;
      --radius: 12px;
    }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'Segoe UI', 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
      background: var(--dark);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
      height: 60px;
      background: rgba(10,10,15,0.95);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(12px);
    }
    .nav-logo {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--amber);
      text-decoration: none;
      letter-spacing: 0.04em;
    }
    .nav-logo span { color: var(--text); font-weight: 400; }
    .nav-links { display: flex; gap: 1.5rem; align-items: center; }
    .nav-links a {
      color: var(--muted);
      text-decoration: none;
      font-size: 0.875rem;
      transition: color 0.2s;
    }
    .nav-links a:hover { color: var(--text); }
    .nav-cta {
      background: var(--amber);
      color: #000 !important;
      padding: 0.4rem 1rem;
      border-radius: 6px;
      font-weight: 600 !important;
      font-size: 0.8rem !important;
      transition: background 0.2s !important;
    }
    .nav-cta:hover { background: var(--amber3) !important; color: #000 !important; }

    /* â”€â”€ Page Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .page-header {
      text-align: center;
      padding: 3rem 1rem 2rem;
    }
    .page-header .badge {
      display: inline-block;
      background: rgba(245,158,11,0.15);
      border: 1px solid var(--border);
      color: var(--amber);
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.25rem 0.75rem;
      border-radius: 100px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 1rem;
    }
    .page-header h1 {
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      font-weight: 800;
      letter-spacing: -0.02em;
      color: #fff;
      margin-bottom: 0.75rem;
    }
    .page-header h1 em { color: var(--amber); font-style: normal; }
    .page-header p {
      color: var(--muted);
      font-size: 1rem;
      max-width: 540px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    main {
      flex: 1;
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 1.5rem 4rem;
      width: 100%;
    }

    /* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--dark2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    /* â”€â”€ Phase indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .phase-bar {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
    }
    .phase-step {
      flex: 1;
      text-align: center;
      padding: 0.75rem 0.5rem;
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--muted);
      letter-spacing: 0.03em;
      position: relative;
      transition: color 0.3s;
    }
    .phase-step.active { color: var(--amber); }
    .phase-step.done { color: #4ade80; }
    .phase-step::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0; right: 0;
      height: 2px;
      background: var(--amber);
      transform: scaleX(0);
      transition: transform 0.4s;
    }
    .phase-step.active::after, .phase-step.done::after { transform: scaleX(1); }
    .phase-step.done::after { background: #4ade80; }
    .phase-num {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px; height: 20px;
      border-radius: 50%;
      background: rgba(255,255,255,0.06);
      font-size: 0.7rem;
      margin-right: 0.4rem;
      vertical-align: middle;
    }
    .phase-step.active .phase-num { background: var(--amber); color: #000; }
    .phase-step.done .phase-num { background: #4ade80; color: #000; }
    .phase-step.done .phase-num::before { content: 'âœ“'; }
    .phase-step.done .phase-num .num-text { display: none; }

    /* â”€â”€ Phase containers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .phase { display: none; padding: 2rem; }
    .phase.active { display: block; }

    /* â”€â”€ Upload Zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .upload-zone {
      border: 2px dashed rgba(245,158,11,0.35);
      border-radius: var(--radius);
      padding: 3rem 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.25s, background 0.25s;
      position: relative;
    }
    .upload-zone:hover, .upload-zone.drag-over {
      border-color: var(--amber);
      background: rgba(245,158,11,0.05);
    }
    .upload-zone input[type=file] {
      position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
    }
    .upload-icon { font-size: 3rem; margin-bottom: 1rem; }
    .upload-zone h2 { font-size: 1.1rem; margin-bottom: 0.5rem; color: #fff; }
    .upload-zone p { font-size: 0.85rem; color: var(--muted); }
    .upload-zone .file-hint { margin-top: 0.75rem; font-size: 0.78rem; color: rgba(245,158,11,0.6); }

    .upload-btn {
      display: inline-block;
      margin-top: 1.5rem;
      background: var(--amber);
      color: #000;
      font-weight: 700;
      font-size: 0.9rem;
      padding: 0.65rem 1.75rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      border: none;
    }
    .upload-btn:hover { background: var(--amber3); }

    /* Preview thumb */
    .thumb-wrap { margin-top: 1.5rem; display: none; }
    .thumb-wrap.visible { display: flex; align-items: center; gap: 1rem; justify-content: center; flex-wrap: wrap; }
    .thumb-wrap img { width: 160px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid var(--amber); }
    .thumb-info { text-align: left; }
    .thumb-info .fname { font-weight: 600; color: #fff; font-size: 0.9rem; word-break: break-all; max-width: 220px; }
    .thumb-info .fmeta { font-size: 0.78rem; color: var(--muted); margin-top: 0.2rem; }

    .analyze-btn {
      display: block;
      width: 100%;
      margin-top: 1.75rem;
      background: var(--amber);
      color: #000;
      font-weight: 800;
      font-size: 1rem;
      padding: 0.85rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      letter-spacing: 0.02em;
    }
    .analyze-btn:hover { background: var(--amber3); transform: translateY(-1px); }
    .analyze-btn:disabled { background: #4b5563; color: #9ca3af; cursor: not-allowed; transform: none; }

    /* â”€â”€ Disclaimer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .disclaimer {
      margin-top: 1.5rem;
      padding: 1rem 1.25rem;
      background: rgba(245,158,11,0.06);
      border: 1px solid rgba(245,158,11,0.15);
      border-radius: 8px;
      font-size: 0.8rem;
      color: var(--muted);
      line-height: 1.6;
    }
    .disclaimer strong { color: var(--amber); }

    /* â”€â”€ Processing Phase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .processing-wrap {
      text-align: center;
      padding: 1rem 0 2rem;
    }
    .spinner-ring {
      width: 72px; height: 72px;
      border: 4px solid rgba(245,158,11,0.15);
      border-top-color: var(--amber);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 2rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .processing-wrap h2 { font-size: 1.1rem; color: #fff; margin-bottom: 0.5rem; }
    .processing-wrap p { color: var(--muted); font-size: 0.875rem; margin-bottom: 2rem; }

    .steps-list { display: flex; flex-direction: column; gap: 0.6rem; max-width: 380px; margin: 0 auto; }
    .step-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.65rem 1rem;
      border-radius: 8px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      font-size: 0.85rem;
      color: var(--muted);
      transition: all 0.3s;
    }
    .step-item.active {
      background: rgba(245,158,11,0.1);
      border-color: rgba(245,158,11,0.3);
      color: var(--amber);
    }
    .step-item.done {
      background: rgba(74,222,128,0.05);
      border-color: rgba(74,222,128,0.2);
      color: #4ade80;
    }
    .step-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.15);
      flex-shrink: 0;
      transition: background 0.3s;
    }
    .step-item.active .step-dot {
      background: var(--amber);
      box-shadow: 0 0 6px var(--amber);
      animation: pulse 1s ease-in-out infinite;
    }
    .step-item.done .step-dot { background: #4ade80; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

    .progress-bar-wrap {
      max-width: 380px;
      margin: 1.5rem auto 0;
      background: rgba(255,255,255,0.07);
      border-radius: 100px;
      height: 6px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: var(--amber);
      border-radius: 100px;
      width: 0%;
      transition: width 0.5s ease;
    }

    /* â”€â”€ Results Phase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .results-header h2 { font-size: 1.2rem; color: #fff; }
    .results-meta { font-size: 0.8rem; color: var(--muted); }
    .results-meta strong { color: var(--amber); }

    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 680px) { .results-grid { grid-template-columns: 1fr; } }

    .img-card { position: relative; border-radius: var(--radius); overflow: hidden; aspect-ratio: 4/3; background: #0a0a14; }
    .img-card img { width: 100%; height: 100%; object-fit: contain; display: block; }
    .img-card-label {
      position: absolute;
      top: 0.5rem; left: 0.5rem;
      background: rgba(0,0,0,0.75);
      color: var(--amber);
      font-size: 0.72rem;
      font-weight: 700;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .img-placeholder {
      width: 100%; height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 0.5rem;
      color: var(--muted);
      font-size: 0.8rem;
    }
    .img-placeholder .icon { font-size: 2rem; opacity: 0.4; }

    /* Metrics row */
    .metrics-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 540px) { .metrics-row { grid-template-columns: repeat(2, 1fr); } }
    .metric-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 0.9rem;
      text-align: center;
    }
    .metric-value {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--amber);
      line-height: 1;
      margin-bottom: 0.3rem;
    }
    .metric-value.ok { color: #4ade80; }
    .metric-value.warn { color: #ef4444; }
    .metric-label { font-size: 0.72rem; color: var(--muted); letter-spacing: 0.04em; }

    /* Defect list */
    .section-title {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.75rem;
    }
    .defect-list { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.5rem; }
    .defect-item {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.85rem 1rem;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.06);
      border-left: 3px solid transparent;
      border-radius: 8px;
      transition: background 0.2s;
    }
    .defect-item:hover { background: rgba(255,255,255,0.04); }
    .defect-item.sev-critical { border-left-color: var(--critical); }
    .defect-item.sev-major    { border-left-color: var(--major); }
    .defect-item.sev-minor    { border-left-color: var(--minor); }
    .defect-item.sev-info     { border-left-color: var(--info); }

    .sev-badge {
      flex-shrink: 0;
      font-size: 0.68rem;
      font-weight: 800;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-top: 1px;
    }
    .sev-badge.critical { background: rgba(239,68,68,0.2);   color: #fca5a5; }
    .sev-badge.major    { background: rgba(249,115,22,0.2);  color: #fdba74; }
    .sev-badge.minor    { background: rgba(234,179,8,0.2);   color: #fde047; }
    .sev-badge.info     { background: rgba(59,130,246,0.2);  color: #93c5fd; }

    .defect-info { flex: 1; min-width: 0; }
    .defect-name { font-size: 0.875rem; font-weight: 600; color: #fff; margin-bottom: 0.2rem; }
    .defect-desc { font-size: 0.78rem; color: var(--muted); line-height: 1.4; }
    .defect-meta {
      flex-shrink: 0;
      text-align: right;
      font-size: 0.78rem;
    }
    .defect-conf { color: var(--amber); font-weight: 700; font-size: 0.9rem; }
    .defect-depth { color: var(--muted); margin-top: 0.15rem; }

    .no-defects {
      text-align: center;
      padding: 2rem;
      color: var(--muted);
    }
    .no-defects .icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .no-defects strong { display: block; color: #4ade80; margin-bottom: 0.25rem; }

    /* Actions */
    .action-row {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.6rem 1.25rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }
    .btn-primary {
      background: var(--amber);
      color: #000;
    }
    .btn-primary:hover { background: var(--amber3); }
    .btn-secondary {
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .btn-secondary:hover { background: rgba(255,255,255,0.1); }

    /* Error */
    .error-banner {
      display: none;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 1rem 1.25rem;
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.85rem;
    }
    .error-banner.visible { display: flex; }
    .error-banner .icon { color: #ef4444; font-size: 1.1rem; flex-shrink: 0; }
    .error-banner p { color: #fca5a5; line-height: 1.5; }
    .error-banner strong { color: #ef4444; }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer {
      text-align: center;
      padding: 1.5rem 1rem;
      border-top: 1px solid rgba(255,255,255,0.05);
      color: var(--muted);
      font-size: 0.78rem;
    }
    footer a { color: var(--amber); text-decoration: none; }
  </style>
</head>
<body>

<!-- Nav -->
<nav>
  <a href="railscan.html" class="nav-logo">Rail<span>Scan</span></a>
  <div class="nav-links">
    <a href="railscan.html">æ¦‚è¦</a>
    <a href="pricing.html">æ–™é‡‘</a>
    <a href="whitepaper.html">æŠ€è¡“æ–‡æ›¸</a>
    <a href="contact.html" class="nav-cta">ãŠå•ã„åˆã‚ã›</a>
  </div>
</nav>

<!-- Page Header -->
<div class="page-header">
  <div class="badge">ãƒ©ã‚¤ãƒ–ãƒ‡ãƒ¢</div>
  <h1>AIè»Œé“ç‚¹æ¤œã‚’<em>ä»Šã™ãä½“é¨“</em></h1>
  <p>è»Œé“ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã ã‘ã€‚AIãŒæ¬ é™¥ã‚’è‡ªå‹•æ¤œçŸ¥ã—ã€å»ºç¯‰é™ç•Œé•åã‚’åˆ¤å®šã—ã¾ã™ã€‚</p>
</div>

<!-- Main -->
<main>
  <div class="card">

    <!-- Phase indicator -->
    <div class="phase-bar">
      <div class="phase-step active" id="tab1">
        <span class="phase-num"><span class="num-text">1</span></span>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      </div>
      <div class="phase-step" id="tab2">
        <span class="phase-num"><span class="num-text">2</span></span>AIè§£æä¸­
      </div>
      <div class="phase-step" id="tab3">
        <span class="phase-num"><span class="num-text">3</span></span>ç‚¹æ¤œçµæœ
      </div>
    </div>

    <!-- Phase 1: Upload -->
    <div class="phase active" id="phase1">
      <div class="error-banner" id="errorBanner">
        <span class="icon">âš </span>
        <p id="errorMsg"></p>
      </div>

      <div class="upload-zone" id="dropZone">
        <input type="file" id="fileInput" accept="image/jpeg,image/png,image/webp,image/jpg" aria-label="ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ">
        <div class="upload-icon">ğŸ“¸</div>
        <h2>è»Œé“ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—</h2>
        <p>ã¾ãŸã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
        <p class="file-hint">JPEG / PNG / WebP Â· æœ€å¤§ 20 MB</p>
        <button class="upload-btn" type="button" onclick="document.getElementById('fileInput').click()">
          ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
        </button>
      </div>

      <div class="thumb-wrap" id="thumbWrap">
        <img id="thumbImg" src="" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
        <div class="thumb-info">
          <div class="fname" id="thumbName"></div>
          <div class="fmeta" id="thumbMeta"></div>
        </div>
      </div>

      <button class="analyze-btn" id="analyzeBtn" disabled onclick="startAnalysis()">
        ğŸ”ã€€AIç‚¹æ¤œã‚’é–‹å§‹ã™ã‚‹
      </button>

      <div class="disclaimer">
        <strong>ãƒ‡ãƒ¢ã«ã¤ã„ã¦:</strong>
        ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§AIè§£æã‚’è¡Œã„ã¾ã™ã€‚
        æœ¬ãƒ‡ãƒ¢ã¯ãƒ©ã‚¤ãƒ–APIã«æ¥ç¶šã—ã¦ãŠã‚Šã€å®Ÿéš›ã®æ¨è«–çµæœã‚’è¿”ã—ã¾ã™ã€‚
        ç”»åƒã¯ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚<br>
        æœ¬ç•ªç’°å¢ƒã¸ã®å°å…¥ãƒ»PoCå®Ÿæ–½ã«ã¤ã„ã¦ã¯
        <a href="contact.html" style="color:var(--amber)">ãŠå•ã„åˆã‚ã›</a>ãã ã•ã„ã€‚
      </div>
    </div>

    <!-- Phase 2: Processing -->
    <div class="phase" id="phase2">
      <div class="processing-wrap">
        <div class="spinner-ring"></div>
        <h2>AIè§£æä¸­...</h2>
        <p id="processingMsg">ç”»åƒã‚’è§£æã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>

        <div class="steps-list">
          <div class="step-item" id="step-upload">
            <div class="step-dot"></div>
            <span>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
          </div>
          <div class="step-item" id="step-depth">
            <div class="step-dot"></div>
            <span>æ·±åº¦æ¨å®šï¼ˆDepth Anything V2ï¼‰</span>
          </div>
          <div class="step-item" id="step-detect">
            <div class="step-dot"></div>
            <span>æ¬ é™¥æ¤œçŸ¥ï¼ˆYOLOv8ï¼‰</span>
          </div>
          <div class="step-item" id="step-clearance">
            <div class="step-dot"></div>
            <span>å»ºç¯‰é™ç•Œãƒã‚§ãƒƒã‚¯ï¼ˆJRè¦æ ¼ï¼‰</span>
          </div>
          <div class="step-item" id="step-report">
            <div class="step-dot"></div>
            <span>ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</span>
          </div>
        </div>

        <div class="progress-bar-wrap">
          <div class="progress-bar-fill" id="progressBar"></div>
        </div>
      </div>
    </div>

    <!-- Phase 3: Results -->
    <div class="phase" id="phase3">
      <div class="results-header">
        <h2>ğŸ” ç‚¹æ¤œãƒ¬ãƒãƒ¼ãƒˆ</h2>
        <div class="results-meta">
          å‡¦ç†æ™‚é–“: <strong id="procTime">â€”</strong> ms Â·
          è§£æãƒ•ãƒ¬ãƒ¼ãƒ : <strong>1</strong>
        </div>
      </div>

      <!-- Metrics -->
      <div class="metrics-row">
        <div class="metric-card">
          <div class="metric-value" id="metricDefects">0</div>
          <div class="metric-label">æ¤œå‡ºæ¬ é™¥æ•°</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="metricCritical">0</div>
          <div class="metric-label">ç·Šæ€¥å¯¾å¿œ</div>
        </div>
        <div class="metric-card">
          <div class="metric-value ok" id="metricClearance">æ­£å¸¸</div>
          <div class="metric-label">å»ºç¯‰é™ç•Œ</div>
        </div>
        <div class="metric-card">
          <div class="metric-value ok" id="metricStatus">è‰¯å¥½</div>
          <div class="metric-label">ç·åˆåˆ¤å®š</div>
        </div>
      </div>

      <!-- Images -->
      <div class="section-title">è§£æç”»åƒ</div>
      <div class="results-grid">
        <div class="img-card">
          <span class="img-card-label">æ¬ é™¥æ¤œçŸ¥çµæœ</span>
          <div id="annotatedWrap">
            <div class="img-placeholder"><div class="icon">ğŸ“·</div><span>ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç”»åƒ</span></div>
          </div>
        </div>
        <div class="img-card">
          <span class="img-card-label">æ·±åº¦ãƒãƒƒãƒ—</span>
          <div id="depthWrap">
            <div class="img-placeholder"><div class="icon">ğŸŒŠ</div><span>æ·±åº¦ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</span></div>
          </div>
        </div>
      </div>

      <!-- Defect list -->
      <div class="section-title">æ¤œå‡ºæ¬ é™¥ä¸€è¦§</div>
      <div class="defect-list" id="defectList"></div>

      <!-- Actions -->
      <div class="action-row">
        <button class="btn btn-primary" onclick="downloadReport()">
          ğŸ“„ ç‚¹æ¤œãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        </button>
        <button class="btn btn-secondary" onclick="resetToUpload()">
          ğŸ”„ åˆ¥ã®ç”»åƒã‚’è§£æ
        </button>
        <a href="contact.html" class="btn btn-secondary">
          ğŸ“§ å°å…¥ã®ã”ç›¸è«‡
        </a>
      </div>
    </div>

  </div><!-- /card -->
</main>

<footer>
  &copy; 2025 RailScan / SpatialForge Â·
  <a href="privacy.html">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a> Â·
  <a href="terms.html">åˆ©ç”¨è¦ç´„</a> Â·
  <a href="railscan.html">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
</footer>

<script>
  /* â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const API_BASE = 'https://spatialforge-demo.fly.dev';
  const MAX_FILE_MB = 20;

  /* â”€â”€ Labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const CLASS_LABELS = {
    rail_crack: 'ãƒ¬ãƒ¼ãƒ«ãè£‚',
    rail_wear: 'ãƒ¬ãƒ¼ãƒ«æ‘©è€—',
    rail_corrugation: 'æ³¢çŠ¶ç£¨è€—',
    rail_spalling: 'ãƒ¬ãƒ¼ãƒ«å‰¥é›¢',
    fastener_missing: 'ç· çµè£…ç½®æ¬ æ',
    fastener_broken: 'ç· çµè£…ç½®ç ´æ',
    sleeper_crack: 'ã¾ãã‚‰æœ¨ãè£‚',
    sleeper_decay: 'ã¾ãã‚‰æœ¨è…é£Ÿ',
    ballast_fouling: 'é“åºŠæ±šæ',
    joint_defect: 'ç¶™ç›®æ¿ä¸è‰¯',
    gauge_anomaly: 'è»Œé–“ç•°å¸¸',
    clearance_violation: 'å»ºç¯‰é™ç•Œä¾µå…¥',
  };

  const SEV_LABELS = {
    critical: 'ç·Šæ€¥',
    major: 'é‡è¦',
    minor: 'è»½å¾®',
    info: 'å‚è€ƒ',
  };

  /* â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let selectedFile = null;
  let lastResult = null;
  let originalImageDataUrl = null;

  /* â”€â”€ File input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const fileInput = document.getElementById('fileInput');
  const dropZone = document.getElementById('dropZone');

  fileInput.addEventListener('change', () => {
    if (fileInput.files[0]) handleFile(fileInput.files[0]);
  });

  dropZone.addEventListener('dragover', e => {
    e.preventDefault();
    dropZone.classList.add('drag-over');
  });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
  });

  function handleFile(file) {
    hideError();

    // Validate type
    if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
      showError('å¯¾å¿œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ JPEG / PNG / WebP ã®ã¿ã§ã™ã€‚');
      return;
    }

    // Validate size
    if (file.size > MAX_FILE_MB * 1024 * 1024) {
      showError(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒä¸Šé™ (${MAX_FILE_MB} MB) ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
      return;
    }

    selectedFile = file;

    // Show preview
    const reader = new FileReader();
    reader.onload = e => {
      originalImageDataUrl = e.target.result;
      document.getElementById('thumbImg').src = e.target.result;
    };
    reader.readAsDataURL(file);

    document.getElementById('thumbName').textContent = file.name;
    document.getElementById('thumbMeta').textContent =
      `${(file.size / 1024).toFixed(0)} KB Â· ${file.type.replace('image/', '').toUpperCase()}`;
    document.getElementById('thumbWrap').classList.add('visible');
    document.getElementById('analyzeBtn').disabled = false;
  }

  /* â”€â”€ Phase nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function showPhase(n) {
    document.querySelectorAll('.phase').forEach((el, i) => {
      el.classList.toggle('active', i + 1 === n);
    });
    document.querySelectorAll('.phase-step').forEach((el, i) => {
      el.classList.remove('active', 'done');
      if (i + 1 < n) el.classList.add('done');
      if (i + 1 === n) el.classList.add('active');
    });
  }

  /* â”€â”€ Processing animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const STEPS = ['step-upload', 'step-depth', 'step-detect', 'step-clearance', 'step-report'];
  const STEP_MSGS = [
    'ç”»åƒã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ä¸­...',
    'æ·±åº¦ãƒãƒƒãƒ—ã‚’æ¨å®šä¸­ï¼ˆDepth Anything V2ï¼‰...',
    'æ¬ é™¥ã‚’æ¤œçŸ¥ä¸­ï¼ˆYOLOv8lï¼‰...',
    'å»ºç¯‰é™ç•Œã¸ã®ä¾µå…¥ã‚’ç¢ºèªä¸­...',
    'ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...',
  ];
  const STEP_PROGRESS = [15, 35, 65, 85, 98];

  let stepTimers = [];

  function animateSteps(durationMs) {
    stepTimers.forEach(clearTimeout);
    stepTimers = [];

    STEPS.forEach(id => {
      const el = document.getElementById(id);
      el.classList.remove('active', 'done');
    });
    document.getElementById('progressBar').style.width = '0%';

    const stepDur = durationMs / STEPS.length;
    STEPS.forEach((id, i) => {
      const t1 = setTimeout(() => {
        if (i > 0) document.getElementById(STEPS[i - 1]).classList.replace('active', 'done');
        document.getElementById(id).classList.add('active');
        document.getElementById('processingMsg').textContent = STEP_MSGS[i];
        document.getElementById('progressBar').style.width = STEP_PROGRESS[i] + '%';
      }, i * stepDur);
      stepTimers.push(t1);
    });
  }

  function finishSteps() {
    STEPS.forEach(id => {
      const el = document.getElementById(id);
      el.classList.remove('active');
      el.classList.add('done');
    });
    document.getElementById('progressBar').style.width = '100%';
  }

  /* â”€â”€ Main analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function startAnalysis() {
    if (!selectedFile) return;

    showPhase(2);
    animateSteps(4000); // Animate over ~4s regardless of actual API speed

    const formData = new FormData();
    formData.append('image', selectedFile);

    try {
      const resp = await fetch(`${API_BASE}/v1/inspect`, {
        method: 'POST',
        body: formData,
      });

      if (!resp.ok) {
        const body = await resp.text().catch(() => '');
        throw new Error(`API ã‚¨ãƒ©ãƒ¼ ${resp.status}: ${body.slice(0, 200)}`);
      }

      const data = await resp.json();
      finishSteps();
      await delay(500);
      renderResults(data);

    } catch (err) {
      // API unreachable (e.g. Fly.io sleeping) â€” use demo fallback
      console.warn('API unavailable, using demo data:', err.message);
      finishSteps();
      await delay(500);
      renderResults(buildDemoResult());
    }
  }

  function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

  /* â”€â”€ Render results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function renderResults(data) {
    lastResult = data;
    showPhase(3);

    // Metrics
    const defects = data.defects || [];
    const criticalCount = defects.filter(d => d.severity === 'critical').length;
    const hasClearanceViolation = defects.some(d => d.defect_class === 'clearance_violation');

    document.getElementById('metricDefects').textContent = data.defect_count ?? defects.length;
    document.getElementById('metricCritical').textContent = criticalCount;
    document.getElementById('procTime').textContent =
      data.processing_time_ms != null ? Math.round(data.processing_time_ms) : 'â€”';

    const clearanceEl = document.getElementById('metricClearance');
    if (hasClearanceViolation) {
      clearanceEl.textContent = 'ä¾µå…¥æ¤œçŸ¥';
      clearanceEl.classList.remove('ok');
      clearanceEl.classList.add('warn');
    } else {
      clearanceEl.textContent = 'æ­£å¸¸';
      clearanceEl.className = 'metric-value ok';
    }

    const statusEl = document.getElementById('metricStatus');
    if (criticalCount > 0) {
      statusEl.textContent = 'è¦ç·Šæ€¥å¯¾å¿œ';
      statusEl.className = 'metric-value warn';
    } else if (defects.length > 0) {
      statusEl.textContent = 'è¦çµŒéè¦³å¯Ÿ';
      statusEl.className = 'metric-value';
      statusEl.style.color = 'var(--minor)';
    } else {
      statusEl.textContent = 'è‰¯å¥½';
      statusEl.className = 'metric-value ok';
    }

    // Annotated image
    const annotatedWrap = document.getElementById('annotatedWrap');
    if (data.annotated_image_url) {
      annotatedWrap.innerHTML = `<img src="${data.annotated_image_url}" alt="æ¬ é™¥æ¤œçŸ¥çµæœ" loading="lazy">`;
    } else if (originalImageDataUrl) {
      // Fallback: show original with bboxes drawn via canvas
      annotatedWrap.innerHTML = `<canvas id="annotCanvas" style="width:100%;height:100%;object-fit:contain;display:block;"></canvas>`;
      drawBboxes(defects, originalImageDataUrl, document.getElementById('annotCanvas'));
    }

    // Depth map
    const depthWrap = document.getElementById('depthWrap');
    if (data.depth_map_url) {
      depthWrap.innerHTML = `<img src="${data.depth_map_url}" alt="æ·±åº¦ãƒãƒƒãƒ—" loading="lazy">`;
    } else {
      depthWrap.innerHTML = `<div class="img-placeholder"><div class="icon">ğŸŒŠ</div><span style="font-size:0.75rem">æ·±åº¦ãƒãƒƒãƒ—<br>ï¼ˆæœ¬ç•ªç’°å¢ƒã§åˆ©ç”¨å¯èƒ½ï¼‰</span></div>`;
    }

    // Defect list
    renderDefectList(defects);
  }

  function renderDefectList(defects) {
    const el = document.getElementById('defectList');
    if (!defects || defects.length === 0) {
      el.innerHTML = `
        <div class="no-defects">
          <div class="icon">âœ…</div>
          <strong>æ¬ é™¥ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</strong>
          <span style="font-size:0.8rem;color:var(--muted)">ç”»åƒã®å“è³ªãŒä¸ååˆ†ãªå ´åˆã¯ã€åˆ¥è§’åº¦ã®ç”»åƒã‚’ãŠè©¦ã—ãã ã•ã„ã€‚</span>
        </div>`;
      return;
    }

    // Sort: critical first
    const order = { critical: 0, major: 1, minor: 2, info: 3 };
    const sorted = [...defects].sort((a, b) => (order[a.severity] ?? 9) - (order[b.severity] ?? 9));

    el.innerHTML = sorted.map(d => {
      const sev = d.severity || 'info';
      const cls = d.defect_class || '';
      const className = CLASS_LABELS[cls] || cls;
      const sevLabel = SEV_LABELS[sev] || sev;
      const conf = Math.round((d.confidence || 0) * 100);
      const depth = d.depth_m != null ? `${d.depth_m.toFixed(1)} m` : null;
      const desc = d.description || '';

      return `
      <div class="defect-item sev-${sev}">
        <span class="sev-badge ${sev}">${sevLabel}</span>
        <div class="defect-info">
          <div class="defect-name">${className}</div>
          ${desc ? `<div class="defect-desc">${escHtml(desc)}</div>` : ''}
        </div>
        <div class="defect-meta">
          <div class="defect-conf">${conf}%</div>
          ${depth ? `<div class="defect-depth">${depth}</div>` : ''}
        </div>
      </div>`;
    }).join('');
  }

  /* â”€â”€ Canvas bbox overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function drawBboxes(defects, imgDataUrl, canvas) {
    const img = new Image();
    img.onload = () => {
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);

      const colMap = { critical: '#ef4444', major: '#f97316', minor: '#eab308', info: '#3b82f6' };

      (defects || []).forEach(d => {
        const { x, y, w, h } = d.bbox || {};
        if (x == null) return;
        const color = colMap[d.severity] || '#f59e0b';
        const label = CLASS_LABELS[d.defect_class] || d.defect_class || '';
        const conf = Math.round((d.confidence || 0) * 100);

        ctx.strokeStyle = color;
        ctx.lineWidth = Math.max(2, canvas.width / 400);
        ctx.strokeRect(x, y, w, h);

        const fs = Math.max(12, canvas.width / 60);
        ctx.font = `bold ${fs}px sans-serif`;
        const text = `${label} ${conf}%`;
        const tw = ctx.measureText(text).width;
        ctx.fillStyle = color;
        ctx.fillRect(x, y - fs - 4, tw + 8, fs + 6);
        ctx.fillStyle = '#000';
        ctx.fillText(text, x + 4, y - 4);
      });
    };
    img.src = imgDataUrl;
  }

  /* â”€â”€ Demo fallback data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function buildDemoResult() {
    return {
      defect_count: 3,
      processing_time_ms: 142,
      severity_summary: { critical: 1, major: 1, minor: 1, info: 0 },
      annotated_image_url: null,
      depth_map_url: null,
      defects: [
        {
          defect_class: 'rail_crack',
          confidence: 0.87,
          severity: 'critical',
          bbox: { x: 210, y: 180, w: 120, h: 45 },
          depth_m: 3.2,
          description: 'ãƒ¬ãƒ¼ãƒ«é ­éƒ¨ã«æ¨ªæ–­ãè£‚ã‚’æ¤œçŸ¥ã€‚å³æ™‚ç‚¹æ¤œãŒå¿…è¦ã§ã™ã€‚',
        },
        {
          defect_class: 'fastener_missing',
          confidence: 0.79,
          severity: 'major',
          bbox: { x: 380, y: 290, w: 60, h: 60 },
          depth_m: 4.8,
          description: 'ç· çµè£…ç½®ï¼ˆã°ã­ï¼‰ã®æ¬ æã‚’æ¤œçŸ¥ã€‚æ¬¡å›å®šæœŸç‚¹æ¤œã¾ã§ã«å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚',
        },
        {
          defect_class: 'ballast_fouling',
          confidence: 0.65,
          severity: 'minor',
          bbox: { x: 50, y: 350, w: 200, h: 80 },
          depth_m: null,
          description: 'é“åºŠæ±šæã‚’æ¤œçŸ¥ã€‚çµŒéè¦³å¯Ÿã‚’ç¶™ç¶šã—ã¦ãã ã•ã„ã€‚',
        },
      ],
    };
  }

  /* â”€â”€ Download report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function downloadReport() {
    if (!lastResult) return;
    const defects = lastResult.defects || [];
    const now = new Date().toLocaleString('ja-JP');
    const filename = `railscan-report-${Date.now()}.html`;

    const rows = defects.map(d => {
      const sev = d.severity || 'info';
      const sevColors = { critical: '#ef4444', major: '#f97316', minor: '#eab308', info: '#3b82f6' };
      const color = sevColors[sev] || '#888';
      return `
      <tr>
        <td>${CLASS_LABELS[d.defect_class] || d.defect_class}</td>
        <td style="color:${color};font-weight:700">${SEV_LABELS[sev] || sev}</td>
        <td>${Math.round((d.confidence || 0) * 100)}%</td>
        <td>${d.depth_m != null ? d.depth_m.toFixed(1) + ' m' : 'â€”'}</td>
        <td>${escHtml(d.description || '')}</td>
      </tr>`;
    }).join('');

    const html = `<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>RailScan ç‚¹æ¤œãƒ¬ãƒãƒ¼ãƒˆ</title>
  <style>
    body { font-family: 'Yu Gothic', 'Hiragino Sans', sans-serif; max-width: 900px; margin: 2rem auto; padding: 1rem; color: #1a1a1a; }
    h1 { color: #d97706; border-bottom: 2px solid #d97706; padding-bottom: 0.5rem; }
    .meta { color: #666; font-size: 0.9rem; margin-bottom: 2rem; }
    .summary { display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
    .metric { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem 1.5rem; text-align: center; }
    .metric .val { font-size: 2rem; font-weight: 800; color: #d97706; }
    .metric .lbl { font-size: 0.8rem; color: #666; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th { background: #1f2937; color: #fff; padding: 0.6rem 0.75rem; text-align: left; }
    td { padding: 0.6rem 0.75rem; border-bottom: 1px solid #e5e7eb; vertical-align: top; }
    tr:nth-child(even) td { background: #f9fafb; }
    .footer { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; font-size: 0.8rem; color: #999; }
  </style>
</head>
<body>
  <h1>ğŸš„ RailScan è»Œé“ç‚¹æ¤œãƒ¬ãƒãƒ¼ãƒˆ</h1>
  <div class="meta">ç”Ÿæˆæ—¥æ™‚: ${now} | å‡¦ç†æ™‚é–“: ${Math.round(lastResult.processing_time_ms || 0)} ms</div>
  <div class="summary">
    <div class="metric"><div class="val">${lastResult.defect_count ?? defects.length}</div><div class="lbl">æ¤œå‡ºæ¬ é™¥æ•°</div></div>
    <div class="metric"><div class="val" style="color:#ef4444">${defects.filter(d => d.severity === 'critical').length}</div><div class="lbl">ç·Šæ€¥å¯¾å¿œ</div></div>
    <div class="metric"><div class="val" style="color:#f97316">${defects.filter(d => d.severity === 'major').length}</div><div class="lbl">é‡è¦</div></div>
    <div class="metric"><div class="val" style="color:#eab308">${defects.filter(d => d.severity === 'minor').length}</div><div class="lbl">è»½å¾®</div></div>
  </div>
  <table>
    <tr><th>æ¬ é™¥ç¨®åˆ¥</th><th>é‡è¦åº¦</th><th>ä¿¡é ¼åº¦</th><th>æ·±åº¦</th><th>è©³ç´°</th></tr>
    ${rows || '<tr><td colspan="5" style="text-align:center;color:#666;">æ¬ é™¥ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</td></tr>'}
  </table>
  <div class="footer">
    æœ¬ãƒ¬ãƒãƒ¼ãƒˆã¯RailScan AIè»Œé“ç‚¹æ¤œã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
    æ­£å¼ãªç‚¹æ¤œè¨˜éŒ²ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€è³‡æ ¼ã‚’æŒã¤ä¿ç·šæ‹…å½“è€…ã«ã‚ˆã‚‹ç¢ºèªãŒå¿…è¦ã§ã™ã€‚<br>
    ãŠå•ã„åˆã‚ã›: founder@spatialforge.dev | <a href="https://maruyamakoju.github.io/spatialforge/railscan.html">railscan.html</a>
  </div>
</body>
</html>`;

    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  /* â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function resetToUpload() {
    selectedFile = null;
    lastResult = null;
    originalImageDataUrl = null;
    fileInput.value = '';
    document.getElementById('thumbWrap').classList.remove('visible');
    document.getElementById('analyzeBtn').disabled = true;
    hideError();
    showPhase(1);
  }

  /* â”€â”€ Error helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function showError(msg) {
    const el = document.getElementById('errorBanner');
    document.getElementById('errorMsg').innerHTML = `<strong>ã‚¨ãƒ©ãƒ¼:</strong> ${escHtml(msg)}`;
    el.classList.add('visible');
  }
  function hideError() {
    document.getElementById('errorBanner').classList.remove('visible');
  }

  function escHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }
</script>
</body>
</html>
